async function loginViewer(){
  loginErr.style.display = "none";

  const u = (viewerUser.value || "").trim().toUpperCase();
  if(!u) return showErr("INGRESA USUARIO");

  const { data, error } = await sb
    .from('viewer_users')
    .select('id, username, approved')
    .eq('username', u)
    .limit(1);

  if(error) return showErr("ERROR: " + error.message);

  // ✅ CASO 1: NO EXISTE -> CREAR SOLICITUD PENDIENTE Y ESCUCHAR APROBACIÓN
  if(!data || !data.length){
    await createAccessRequest(u);
    subscribeToApproval(u); // escucha INSERT/UPDATE en viewer_users
    return showErr("USUARIO NO REGISTRADO. SOLICITUD ENVIADA ✅ (PENDIENTE DE APROBACIÓN)");
  }

  const viewer = data[0];

  // ✅ CASO 2: EXISTE PERO NO APROBADO -> SOLICITUD + ESPERAR
  if(viewer.approved !== true){
    await createAccessRequest(u, viewer.id);
    subscribeToApproval(u);
    return showErr("ACCESO PENDIENTE DE APROBACIÓN ⏳");
  }

  // ✅ CASO 3: EXISTE Y APROBADO -> ENTRA
  localStorage.setItem("viewer_user", viewer.username);
  localStorage.setItem("viewer_user_id", viewer.id);

  loginOverlay.style.display = "none";
  whoTxt.innerText = "USUARIO: " + viewer.username;

  loadMenusForDate(getToday());
}

async function createAccessRequest(username, viewerUserId=null){
  // Evita duplicar solicitudes pendientes
  const { data: existing, error: exErr } = await sb
    .from('viewer_access_requests')
    .select('id, status')
    .eq('username', username)
    .eq('status', 'pending')
    .limit(1);

  if(exErr){
    console.warn(exErr);
    return;
  }

  if(existing && existing.length) return;

  const payload = { username, status: 'pending' };
  if(viewerUserId) payload.viewer_user_id = viewerUserId;

  const { error } = await sb.from('viewer_access_requests').insert([payload]);
  if(error) console.warn(error);
}

function subscribeToApproval(username){
  // escucha tanto INSERT como UPDATE para cuando el admin cree o apruebe
  try{
    if(window.approveChannel){
      sb.removeChannel(window.approveChannel);
      window.approveChannel = null;
    }
  }catch(_){}

  window.approveChannel = sb.channel('viewer-approval-' + username)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'viewer_users',
      filter: `username=eq.${username}`
    }, (payload) => {
      const row = payload?.new || {};
      if(row.approved === true){
        localStorage.setItem("viewer_user", row.username);
        localStorage.setItem("viewer_user_id", row.id);
        loginOverlay.style.display = "none";
        whoTxt.innerText = "USUARIO: " + row.username;
        loadMenusForDate(getToday());
      }
    })
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'viewer_users',
      filter: `username=eq.${username}`
    }, (payload) => {
      const row = payload?.new || {};
      if(row.approved === true){
        localStorage.setItem("viewer_user", row.username);
        localStorage.setItem("viewer_user_id", row.id);
        loginOverlay.style.display = "none";
        whoTxt.innerText = "USUARIO: " + row.username;
        loadMenusForDate(getToday());
      }
    })
    .subscribe();
}
