<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>MENÚ DIGITAL | ADT</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700;900&display=swap">
  <style>
    :root { --bg: #161c2d; --card: #2d3250; --border: #424769; --accent: #f9b17a; --text: #ffffff; }
    * { box-sizing: border-box; text-transform: uppercase; font-family: 'Raleway', sans-serif; }
    body { margin: 0; min-height: 100vh; background: var(--bg); color: white; display: flex; align-items: center; justify-content: center; }
    #accessOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .access-card { background: var(--card); padding: 40px; border-radius: 24px; width: 100%; max-width: 380px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
    .access-card input { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: #fff; text-transform: none !important; font-size: 16px; margin-bottom: 20px; outline: none; }
    .btn-access { width: 100%; padding: 16px; background: var(--accent); border: none; border-radius: 12px; font-weight: 900; color: var(--bg); cursor: pointer; }
    #mainContent { width: 100%; max-width: 800px; padding: 40px 20px; opacity: 0; transition: 0.5s; display: none; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="accessOverlay">
    <div class="access-card">
      <h1 style="font-size:60px; letter-spacing:-4px; margin-bottom:20px;">ADT</h1>
      <p style="font-size: 10px; color: #94a3b8; margin-bottom: 25px;">INGRESA TU USUARIO</p>
      <input id="userInput" type="email" placeholder="correo@ejemplo.com">
      <button class="btn-access" onclick="verify()">ACCEDER AL MENÚ</button>
      <p id="err" style="color:#ef4444; font-size:11px; margin-top:15px; display:none; text-transform:none;">USUARIO NO AUTORIZADO</p>
    </div>
  </div>

  <main id="mainContent">
      <div id="dateDisplay" style="text-align:center; font-weight:900; color:var(--accent); margin-bottom:30px; font-size: 20px;">...</div>
      <div id="menusContainer"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const S_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co", S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    const saved = localStorage.getItem('adt_session');
    if (saved) { checkDB(saved); }

    async function verify() {
      const email = userInput.value.trim().toLowerCase();
      if (!email) return;
      checkDB(email);
    }

    async function checkDB(email) {
      const { data } = await sb.from('user_permissions').select('can_access_index').eq('email', email).maybeSingle();
      if (data && data.can_access_index) {
        localStorage.setItem('adt_session', email);
        accessOverlay.classList.add('hidden');
        mainContent.style.display = "block";
        setTimeout(() => mainContent.style.opacity = "1", 50);
        loadMenus();
      } else {
        localStorage.removeItem('adt_session');
        err.style.display = "block";
      }
    }

    async function loadMenus() {
      const today = new Date().toLocaleString("en-CA", {timeZone: "America/Santiago"}).split(',')[0];
      const [y, m, d] = today.split("-");
      dateDisplay.innerText = `${d} / ${m} / ${y}`;

      if (!sessionStorage.getItem('v_inc')) { await sb.rpc('increment_visitors'); sessionStorage.setItem('v_inc','1'); }

      const { data: menus } = await sb.from('menus').select(`id, name, menu_menu_items(menu_items(*))`).eq('menu_date', today);
      if (!menus || menus.length === 0) {
        menusContainer.innerHTML = '<div style="text-align:center; padding:50px;">EL MENÚ AÚN NO ESTÁ DISPONIBLE</div>';
        return;
      }

      menusContainer.innerHTML = menus.map(m => {
        const items = m.menu_menu_items.map(rel => rel.menu_items).filter(Boolean);
        const grouped = items.reduce((acc, i) => { 
            const cat = (i.category || "VARIOS").trim().toUpperCase();
            (acc[cat] = acc[cat] || []).push(i); return acc; 
        }, {});
        
        let body = `<div style="background:var(--card); padding:40px; border-radius:30px; border:1px solid var(--border); margin-bottom:30px;"><h2 style="color:var(--accent); font-size:24px; border-left:4px solid var(--accent); padding-left:15px; margin-bottom:25px;">${m.name}</h2>`;
        Object.keys(grouped).sort().forEach(cat => {
            if(cat !== 'MANUAL') body += `<div style="color:#94a3b8; font-size:11px; margin:30px 0 10px; border-bottom:1px solid var(--border); padding-bottom:5px;">${cat}</div>`;
            grouped[cat].forEach(it => {
                body += `<div style="margin-bottom:20px;"><div style="font-size:18px; font-weight:700;">${it.name}</div><div style="font-size:12px; color:#676f9d; text-transform:none;">${it.description || ''}</div></div>`;
            });
        });
        return body + '</div>';
      }).join('');
    }
  </script>
</body>
</html>
