<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menú</title>
  <style>
    :root{--bg:#f6f6f6;--card:#fff;--text:#111;--muted:#666;--line:#e9e9e9;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:28px 18px 60px;}
    h1{font-size:44px; text-align:center; margin:20px 0 8px;}
    .sub{display:flex; justify-content:center; gap:10px; color:var(--muted); margin-bottom:22px; flex-wrap:wrap;}
    .pill{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 12px; font-size:13px;}
    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px 18px; box-shadow:0 2px 10px rgba(0,0,0,.03);}
    .cat{font-size:22px; margin:18px 0 8px; font-weight:800;}
    .item{padding:12px 0; border-top:1px dashed var(--line);}
    .item:first-child{border-top:none;}
    .name{font-weight:800; font-size:18px; margin:0 0 4px;}
    .meta{color:var(--muted); font-size:14px; margin:0 0 6px;}
    .desc{margin:0; color:#222;}
    .empty{color:var(--muted); text-align:center; margin-top:20px;}
    .footer{margin-top:30px; display:flex; justify-content:center;}
    .link{color:#333; text-decoration:none; border:1px solid var(--line); background:#fff; border-radius:999px; padding:10px 14px;}
    .link:hover{filter:brightness(.98);}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Menú</h1>
    <div class="sub" id="menuMeta">
      <span class="pill">Cargando menú…</span>
    </div>

    <div id="content"></div>

    <div class="footer">
      <a class="link" href="./admin.html">Administrar</a>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const menuMetaEl = document.getElementById("menuMeta");
    const contentEl = document.getElementById("content");

    function fmtDate(d) {
      if (!d) return null;
      try {
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return d;
        return dt.toLocaleDateString("es-CL", { year:"numeric", month:"2-digit", day:"2-digit" });
      } catch { return d; }
    }

    function groupByCategory(items) {
      const map = new Map();
      for (const it of items) {
        const cat = (it.category || "Sin categoría").trim() || "Sin categoría";
        if (!map.has(cat)) map.set(cat, []);
        map.get(cat).push(it);
      }
      return map;
    }

    async function getActiveOrLatestMenu() {
      // 1) intenta con is_active (si existe)
      let { data, error } = await supabaseClient
        .from("menus")
        .select("*")
        .eq("is_active", true)
        .order("date", { ascending:false, nullsFirst:false })
        .order("created_at", { ascending:false })
        .limit(1);

      if (!error && data?.length) return data[0];

      // 2) fallback: último por fecha/created_at (si no existe is_active o no hay activos)
      ({ data, error } = await supabaseClient
        .from("menus")
        .select("*")
        .order("date", { ascending:false, nullsFirst:false })
        .order("created_at", { ascending:false })
        .limit(1));

      if (error) throw error;
      return data?.[0] || null;
    }

    async function getMenuLinks(menuId) {
      const { data, error } = await supabaseClient
        .from("menu_menu_items")
        .select("*")
        .eq("menu_id", menuId);

      if (error) throw error;
      return data || [];
    }

    async function getMenuItemsByIds(ids) {
      if (!ids.length) return [];
      const { data, error } = await supabaseClient
        .from("menu_items")
        .select("*")
        .in("id", ids);

      if (error) throw error;
      return data || [];
    }

    function render(menu, items) {
      // meta
      const pills = [];
      const title = menu?.name || menu?.title || "Menú";
      const date = fmtDate(menu?.date);
      pills.push(`<span class="pill"><b>${title}</b></span>`);
      if (date) pills.push(`<span class="pill">${date}</span>`);
      menuMetaEl.innerHTML = pills.join("");

      if (!items.length) {
        contentEl.innerHTML = `<p class="empty">No hay productos disponibles.</p>`;
        return;
      }

      const grouped = groupByCategory(items);

      let html = "";
      for (const [cat, list] of grouped.entries()) {
        html += `<div class="cat">${cat}</div>`;
        html += `<div class="card">`;
        for (const it of list) {
          html += `
            <div class="item">
              <p class="name">${it.name || "Sin nombre"}</p>
              ${it.date ? `<p class="meta">${fmtDate(it.date)}</p>` : ``}
              <p class="desc">${it.description || ""}</p>
            </div>
          `;
        }
        html += `</div>`;
      }

      contentEl.innerHTML = `<div class="grid">${html}</div>`;
    }

    async function main() {
      try {
        const menu = await getActiveOrLatestMenu();
        if (!menu) {
          menuMetaEl.innerHTML = `<span class="pill">No hay menús creados aún.</span>`;
          contentEl.innerHTML = `<p class="empty">Crea un menú desde Admin.</p>`;
          return;
        }

        const links = await getMenuLinks(menu.id);
        const ids = links
          .map(r => r.item_id ?? r.menu_item_id) // soporta ambos
          .filter(Boolean);

        const items = await getMenuItemsByIds(ids);

        // Mantener el orden del puente (si tienes created_at en la tabla puente)
        const orderMap = new Map(ids.map((id, idx) => [id, idx]));
        items.sort((a,b) => (orderMap.get(a.id) ?? 9999) - (orderMap.get(b.id) ?? 9999));

        render(menu, items);
      } catch (e) {
        console.error(e);
        menuMetaEl.innerHTML = `<span class="pill">Error cargando</span>`;
        contentEl.innerHTML = `<p class="empty">Revisa la consola (F12) y tus políticas RLS.</p>`;
      }
    }

    main();
  </script>
</body>
</html>
