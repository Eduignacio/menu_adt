<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Menú</title>
  <style>
    :root{ --bg:#f6f6f6;--card:#fff;--text:#111;--muted:#666;--line:#e9e9e9; --btn:#111; --danger:#b3261e; --ok:#0f7b2d; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text);}
    .wrap{max-width:1150px; margin:0 auto; padding:26px 18px 60px;}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    h1{font-size:40px; margin:8px 0;}
    .actions{display:flex; gap:10px;}
    button, .btn{ border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:800; text-decoration:none; color:inherit; }
    .btnPrimary{background:var(--btn); color:#fff; border-color:var(--btn);}
    .btnDanger{background:var(--danger); color:#fff; border-color:var(--danger);}
    .card{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px 18px; box-shadow:0 2px 10px rgba(0,0,0,.03); margin-bottom:15px;}
    .title{font-size:20px; font-weight:950; margin:0 0 12px;}
    .muted{color:var(--muted); font-size:14px;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;}
    @media (max-width: 800px){.grid2,.grid3{grid-template-columns:1fr;}}
    label{display:block; font-weight:900; margin:10px 0 6px; font-size:13px;}
    input, textarea, select{ width:100%; box-sizing:border-box; border:1px solid var(--line); border-radius:12px; padding:12px; font-size:15px; background:#fff; }
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px; border-top:1px solid var(--line); text-align:left;}
    th{font-size:11px; text-transform:uppercase; color:var(--muted);}
    .hidden{display:none!important;}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Panel Admin</h1>
      <div class="actions">
        <a class="btn" href="./index.html">Ver Menú Público</a>
        <button class="btn" id="btnLogout" style="display:none;">Cerrar sesión</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <p class="title">Acceso</p>
      <div class="grid2">
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPass" type="password" placeholder="Contraseña" />
      </div>
      <button class="btn btnPrimary" id="btnLogin" style="margin-top:15px; width:100%;">Entrar</button>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <!-- GESTIÓN DE MENÚS -->
      <div class="card">
        <p class="title">Seleccionar o Crear Menú</p>
        <div class="grid3">
          <div>
            <label>Historial de menús</label>
            <select id="menuSelect"></select>
          </div>
          <div>
            <label>Nombre del menú</label>
            <input id="menuName" placeholder="Ej: Almuerzo Miércoles" />
          </div>
          <div>
            <label>Fecha del menú</label>
            <input id="menuDate" type="date" />
          </div>
        </div>
        <div class="row" style="margin-top:15px;">
          <span id="menuStatus" class="muted">Seleccione un menú</span>
          <div class="actions">
            <button class="btn btnPrimary" id="btnCreateMenu">Nuevo</button>
            <button class="btn" id="btnUpdateMenu">Guardar Cambios</button>
            <button class="btn btnDanger" id="btnDeleteMenu">Borrar Menú</button>
          </div>
        </div>
      </div>

      <!-- PLATOS -->
      <div class="grid2">
        <!-- FORMULARIO PLATO -->
        <div class="card">
          <p class="title">Plato (Nuevo/Editar)</p>
          <input type="hidden" id="itemId" />
          <label>Nombre</label>
          <input id="itemName" />
          <div class="grid2">
            <div>
              <label>Categoría</label>
              <input id="itemCategory" placeholder="Ej: Postre" />
            </div>
            <div>
              <label>Fecha Plato (opcional)</label>
              <input id="itemDate" type="date" />
            </div>
          </div>
          <label>Descripción</label>
          <textarea id="itemDesc"></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn btnDanger" id="btnDeleteHistoryItem">Borrar del Historial</button>
            <div class="actions">
              <button class="btn" id="btnClearItem">Limpiar</button>
              <button class="btn btnPrimary" id="btnSaveItem">Guardar y Añadir</button>
            </div>
          </div>
        </div>

        <!-- HISTORIAL -->
        <div class="card">
          <p class="title">Historial de Platos</p>
          <input id="searchItems" placeholder="Buscar en historial..." style="margin-bottom:10px;"/>
          <div style="max-height:300px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
            <table>
              <thead><tr><th>Plato</th><th>Acción</th></tr></thead>
              <tbody id="historyItemsTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- TABLA MENÚ ACTUAL -->
      <div class="card">
        <p class="title">Contenido del Menú Seleccionado</p>
        <table style="width:100%">
          <thead>
            <tr><th>Nombre</th><th>Categoría</th><th>Acciones</th></tr>
          </thead>
          <tbody id="menuItemsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Dom Elements
    const loginCard = document.getElementById("loginCard"), app = document.getElementById("app");
    const menuSelect = document.getElementById("menuSelect"), menuName = document.getElementById("menuName"), menuDate = document.getElementById("menuDate");
    const itemId = document.getElementById("itemId"), itemName = document.getElementById("itemName"), itemCategory = document.getElementById("itemCategory"), itemDate = document.getElementById("itemDate"), itemDesc = document.getElementById("itemDesc");

    let currentMenuId = null;
    let historyItemsCache = [];

    // Auth
    async function checkAuth() {
      const { data } = await supabaseClient.auth.getSession();
      const session = data.session;
      loginCard.classList.toggle("hidden", !!session);
      app.classList.toggle("hidden", !session);
      document.getElementById("btnLogout").style.display = session ? "block" : "none";
      if(session) { loadMenus(); loadHistoryItems(); }
    }

    document.getElementById("btnLogin").onclick = async () => {
      const { error } = await supabaseClient.auth.signInWithPassword({ email: loginEmail.value, password: loginPass.value });
      if (error) alert(error.message); else checkAuth();
    };

    document.getElementById("btnLogout").onclick = async () => { await supabaseClient.auth.signOut(); location.reload(); };

    // Menus
    async function loadMenus() {
      const { data } = await supabaseClient.from("menus").select("*").order("menu_date", {ascending:false});
      menuSelect.innerHTML = data.map(m => `<option value="${m.id}">${m.name} (${m.menu_date || 'Sin fecha'})</option>`).join("");
      if (data.length > 0) selectMenu(data[0].id);
    }

    async function selectMenu(id) {
      currentMenuId = id;
      menuSelect.value = id;
      const { data } = await supabaseClient.from("menus").select("*").eq("id", id).single();
      menuName.value = data.name; menuDate.value = data.menu_date;
      loadMenuItems();
    }

    menuSelect.onchange = (e) => selectMenu(e.target.value);

    document.getElementById("btnCreateMenu").onclick = async () => {
      const { data, error } = await supabaseClient.from("menus").insert([{ name: menuName.value, menu_date: menuDate.value }]).select().single();
      if(!error) loadMenus();
    };

    document.getElementById("btnUpdateMenu").onclick = async () => {
      await supabaseClient.from("menus").update({ name: menuName.value, menu_date: menuDate.value }).eq("id", currentMenuId);
      loadMenus();
      alert("Actualizado");
    };

    document.getElementById("btnDeleteMenu").onclick = async () => {
      if(confirm("¿Borrar menú?")) {
        await supabaseClient.from("menus").delete().eq("id", currentMenuId);
        loadMenus();
      }
    };

    // Platos
    async function loadHistoryItems() {
      const { data } = await supabaseClient.from("menu_items").select("*").order("created_at", {ascending:false});
      historyItemsCache = data || [];
      renderHistory();
    }

    function renderHistory() {
      const q = document.getElementById("searchItems").value.toLowerCase();
      const filtered = historyItemsCache.filter(i => i.name.toLowerCase().includes(q));
      document.getElementById("historyItemsTbody").innerHTML = filtered.map(i => `
        <tr>
          <td><b>${i.name}</b><br><small class="muted">${i.category || ''}</small></td>
          <td><button class="btn btnPrimary" onclick="addItemToMenu(${i.id})">Añadir</button></td>
        </tr>
      `).join("");
    }

    document.getElementById("searchItems").oninput = renderHistory;

    async function loadMenuItems() {
      const { data } = await supabaseClient.from("menu_menu_items").select("id, menu_items(*)").eq("menu_id", currentMenuId);
      document.getElementById("menuItemsTbody").innerHTML = data.map(r => `
        <tr>
          <td>${r.menu_items.name}</td>
          <td>${r.menu_items.category || ''}</td>
          <td>
            <button class="btn" onclick="editItem(${r.menu_items.id})">Editar</button>
            <button class="btn btnDanger" onclick="removeFromMenu(${r.id})">Quitar</button>
          </td>
        </tr>
      `).join("");
    }

    window.addItemToMenu = async (id) => {
      await supabaseClient.from("menu_menu_items").insert([{ menu_id: currentMenuId, menu_item_id: id }]);
      loadMenuItems();
    };

    window.removeFromMenu = async (relId) => {
      await supabaseClient.from("menu_menu_items").delete().eq("id", relId);
      loadMenuItems();
    };

    window.editItem = (id) => {
      const it = historyItemsCache.find(x => x.id == id);
      itemId.value = it.id; itemName.value = it.name; itemCategory.value = it.category; itemDate.value = it.date; itemDesc.value = it.description;
    };

    document.getElementById("btnSaveItem").onclick = async () => {
      const payload = { name: itemName.value, category: itemCategory.value, description: itemDesc.value, date: itemDate.value };
      let id = itemId.value;
      if (id) {
        await supabaseClient.from("menu_items").update(payload).eq("id", id);
      } else {
        const { data } = await supabaseClient.from("menu_items").insert([payload]).select().single();
        id = data.id;
      }
      await addItemToMenu(id);
      loadHistoryItems();
      document.getElementById("btnClearItem").click();
    };

    document.getElementById("btnDeleteHistoryItem").onclick = async () => {
      if (itemId.value && confirm("Esto borrará el plato de TODO el historial")) {
        await supabaseClient.from("menu_items").delete().eq("id", itemId.value);
        loadHistoryItems(); loadMenuItems();
        document.getElementById("btnClearItem").click();
      }
    };

    document.getElementById("btnClearItem").onclick = () => {
      itemId.value = ""; itemName.value = ""; itemCategory.value = ""; itemDate.value = ""; itemDesc.value = "";
    };

    checkAuth();
  </script>
</body>
</html>
