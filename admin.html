<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin Menú</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui;background:#f6f6f6;margin:0}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{font-size:42px}
    h2{margin-top:32px}
    .card{background:#fff;padding:16px;border-radius:14px;margin-top:16px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd}
    button{padding:10px 16px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
    .primary{background:#111;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    ul{list-style:none;padding:0}
    li{padding:10px 0;border-bottom:1px solid #eee}
    small{color:#666}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Admin Menú</h1>

  <div class="card">
    <label>Fecha del menú</label>
    <input type="date" id="menuDate">
    <button class="primary" onclick="loadMenu()">Crear / Cargar menú</button>
  </div>

  <div class="card">
    <h2>Platos del menú</h2>
    <ul id="menuPlates"></ul>
  </div>

  <div class="card">
    <h2>Agregar nuevo plato</h2>
    <input id="name" placeholder="Nombre">
    <input id="category" placeholder="Categoría">
    <textarea id="description" placeholder="Descripción"></textarea>
    <button class="primary" onclick="addPlate()">Guardar plato</button>
  </div>

  <div class="card">
    <h2>Historial de platos</h2>
    <ul id="allPlates"></ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = window.supabase.createClient(
  "https://wljgbmgpjqvmaphrlwyh.supabase.co",
  "TU_ANON_KEY"
);

let currentMenuId = null;

async function loadMenu(){
  const date = document.getElementById("menuDate").value;
  if(!date) return alert("Selecciona una fecha");

  let { data: menu } = await supabase
    .from("menus")
    .select("*")
    .eq("date", date)
    .single();

  if(!menu){
    const res = await supabase.from("menus").insert({date}).select().single();
    menu = res.data;
  }

  currentMenuId = menu.id;
  loadMenuPlates();
  loadAllPlates();
}

async function loadMenuPlates(){
  const ul = document.getElementById("menuPlates");
  ul.innerHTML = "";

  const { data } = await supabase
    .from("menu_menu_items")
    .select("menu_items(*)")
    .eq("menu_id", currentMenuId);

  data.forEach(row=>{
    const p = row.menu_items;
    ul.innerHTML += `<li>
      <b>${p.name}</b> – ${p.category}
      <button onclick="removeFromMenu(${p.id})">Quitar</button>
    </li>`;
  });
}

async function loadAllPlates(){
  const ul = document.getElementById("allPlates");
  ul.innerHTML = "";

  const { data } = await supabase.from("menu_items").select("*");

  data.forEach(p=>{
    ul.innerHTML += `<li>
      <b>${p.name}</b> <small>(${p.category})</small>
      <button onclick="addToMenu(${p.id})">Agregar</button>
    </li>`;
  });
}

async function addPlate(){
  const name = document.getElementById("name").value;
  const category = document.getElementById("category").value;
  const description = document.getElementById("description").value;

  if(!name) return alert("Nombre requerido");

  await supabase.from("menu_items").insert({name,category,description});
  loadAllPlates();
}

async function addToMenu(plateId){
  await supabase.from("menu_menu_items").insert({
    menu_id: currentMenuId,
    menu_item_id: plateId
  });
  loadMenuPlates();
}

async function removeFromMenu(plateId){
  await supabase.from("menu_menu_items")
    .delete()
    .eq("menu_id", currentMenuId)
    .eq("menu_item_id", plateId);

  loadMenuPlates();
}
</script>
</body>
</html>
