<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Menú</title>
  <style>
    body { font-family: system-ui, Arial; margin:0; background:#f6f6f6; }
    .wrap { max-width: 1100px; margin:0 auto; padding: 30px 18px 60px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { margin:0; }
    .btn { padding: 10px 14px; border-radius: 12px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    .btn.danger { background:#b42318; color:#fff; border-color:#b42318; }
    .card { background:#fff; border-radius: 16px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,.08); margin-top: 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 850px){ .grid { grid-template-columns: 1fr; } }
    label { font-weight: 700; font-size: 13px; display:block; margin: 10px 0 6px; }
    input, textarea, select { width:100%; padding: 10px; border-radius: 12px; border:1px solid #ddd; font: inherit; }
    textarea { min-height: 90px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px; border-bottom:1px solid #eee; vertical-align: top; }
    th { font-size: 13px; color:#333; }
    .muted { color:#666; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; background:#eee; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Admin Menú</h1>
      <div class="row">
        <a class="btn" href="/index.html">← Volver al menú</a>
        <button class="btn" id="btnLogout">Cerrar sesión</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <h2 style="margin:0 0 10px">Iniciar sesión</h2>
      <div class="grid">
        <div>
          <label>Email</label>
          <input id="loginEmail" placeholder="tu@email.com" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLogin">Entrar</button>
        <span class="muted" id="loginMsg"></span>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminArea" style="display:none">
      <!-- MENÚS -->
      <div class="card">
        <h2 style="margin:0 0 10px">Menús (historial)</h2>

        <div class="grid">
          <div>
            <label>Seleccionar menú existente</label>
            <select id="menuHistory"></select>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnLoadMenu">Editar menú</button>
              <button class="btn danger" id="btnDeleteMenu">Borrar menú</button>
            </div>
          </div>

          <div>
            <label>Crear menú nuevo</label>
            <input id="newMenuTitle" placeholder="Ej: Menú lunes / Menú especial" />
            <label style="margin-top:10px">Fecha (recomendado)</label>
            <input id="newMenuDate" type="date" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnCreateMenu">Agregar menú</button>
              <span class="muted" id="menuMsg"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- EDITAR MENÚ SELECCIONADO -->
      <div class="card">
        <h2 style="margin:0 0 10px">Editar menú seleccionado</h2>
        <div class="grid">
          <div>
            <label>Título</label>
            <input id="editMenuTitle" />
          </div>
          <div>
            <label>Fecha</label>
            <input id="editMenuDate" type="date" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnSaveMenuMeta">Guardar cambios del menú</button>
          <span class="muted" id="menuMetaMsg"></span>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #eee">

        <div class="grid">
          <div>
            <label>Agregar plato desde catálogo</label>
            <select id="catalogSelect"></select>
            <label style="margin-top:10px">Orden (opcional)</label>
            <input id="sortOrder" type="number" value="0" />
            <div class="row" style="margin-top:10px">
              <button class="btn primary" id="btnAddItemToMenu">Agregar al menú</button>
              <span class="muted" id="menuItemsMsg"></span>
            </div>
          </div>

          <div>
            <label>Platos en este menú</label>
            <div id="menuItemsList" class="muted">Selecciona un menú para ver platos.</div>
          </div>
        </div>
      </div>

      <!-- CATÁLOGO DE PLATOS -->
      <div class="card">
        <h2 style="margin:0 0 10px">Catálogo de platos (reutilizable)</h2>

        <div class="grid">
          <div>
            <label>Nombre</label>
            <input id="dishName" placeholder="Ej: Hamburguesa clásica" />
          </div>
          <div>
            <label>Categoría</label>
            <input id="dishCategory" placeholder="Ej: Principal / Entrada / Bebida" />
          </div>
        </div>

        <label>Descripción</label>
        <textarea id="dishDesc" placeholder="Ej: Carne, queso, tomate y papas"></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnCreateDish">Crear plato</button>
          <span class="muted" id="dishMsg"></span>
        </div>

        <hr style="margin:16px 0; border:none; border-top:1px solid #eee">

        <h3 style="margin:0 0 10px">Platos existentes</h3>
        <div id="dishTable"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const SUPABASE_ANON_KEY = "PEGA_AQUI_TU_ANON_KEY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI
    const loginCard = document.getElementById("loginCard");
    const adminArea = document.getElementById("adminArea");
    const loginMsg = document.getElementById("loginMsg");

    const menuHistory = document.getElementById("menuHistory");
    const menuMsg = document.getElementById("menuMsg");
    const menuMetaMsg = document.getElementById("menuMetaMsg");
    const menuItemsMsg = document.getElementById("menuItemsMsg");

    const catalogSelect = document.getElementById("catalogSelect");
    const menuItemsList = document.getElementById("menuItemsList");

    const dishMsg = document.getElementById("dishMsg");
    const dishTable = document.getElementById("dishTable");

    let currentMenuId = null;
    let cachedMenus = [];
    let cachedDishes = [];

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c])); }

    async function refreshAuthUI() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        loginCard.style.display = "none";
        adminArea.style.display = "block";
        await reloadAll();
      } else {
        loginCard.style.display = "block";
        adminArea.style.display = "none";
      }
    }

    // LOGIN
    document.getElementById("btnLogin").addEventListener("click", async () => {
      loginMsg.textContent = "";
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPass").value;

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        loginMsg.textContent = "Error: " + error.message;
        return;
      }
      await refreshAuthUI();
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      await refreshAuthUI();
    });

    // LOAD MENUS
    async function loadMenus() {
      const { data, error } = await supabase
        .from("menus")
        .select("id,title,menu_date,created_at")
        .order("menu_date", { ascending: false, nullsFirst: false })
        .order("created_at", { ascending: false });

      if (error) { console.error(error); return; }
      cachedMenus = data || [];

      if (!cachedMenus.length) {
        menuHistory.innerHTML = `<option value="">No hay menús aún</option>`;
        return;
      }

      menuHistory.innerHTML = `<option value="">(Selecciona un menú)</option>` + cachedMenus.map(m => {
        const label = `${m.menu_date ? m.menu_date + " - " : ""}${m.title}`;
        return `<option value="${m.id}">${esc(label)}</option>`;
      }).join("");
    }

    // CREATE MENU
    document.getElementById("btnCreateMenu").addEventListener("click", async () => {
      menuMsg.textContent = "";
      const title = document.getElementById("newMenuTitle").value.trim();
      const menu_date = document.getElementById("newMenuDate").value || null;

      if (!title) { menuMsg.textContent = "Ponle un título al menú."; return; }

      const { data, error } = await supabase
        .from("menus")
        .insert([{ title, menu_date }])
        .select("id,title,menu_date")
        .single();

      if (error) { menuMsg.textContent = "Error: " + error.message; return; }

      menuMsg.textContent = "Menú creado ✅";
      document.getElementById("newMenuTitle").value = "";
      document.getElementById("newMenuDate").value = "";

      await loadMenus();
      // auto seleccionar el nuevo
      menuHistory.value = String(data.id);
      await loadMenuForEdit(data.id);
    });

    // EDIT MENU (load)
    document.getElementById("btnLoadMenu").addEventListener("click", async () => {
      const id = menuHistory.value;
      if (!id) return;
      await loadMenuForEdit(id);
    });

    async function loadMenuForEdit(menuId) {
      currentMenuId = Number(menuId);

      const menu = cachedMenus.find(m => Number(m.id) === Number(menuId));
      document.getElementById("editMenuTitle").value = menu?.title || "";
      document.getElementById("editMenuDate").value = menu?.menu_date || "";

      await renderMenuItems(menuId);
    }

    // SAVE MENU META
    document.getElementById("btnSaveMenuMeta").addEventListener("click", async () => {
      menuMetaMsg.textContent = "";
      if (!currentMenuId) { menuMetaMsg.textContent = "Selecciona un menú."; return; }

      const title = document.getElementById("editMenuTitle").value.trim();
      const menu_date = document.getElementById("editMenuDate").value || null;

      if (!title) { menuMetaMsg.textContent = "El título no puede ir vacío."; return; }

      const { error } = await supabase
        .from("menus")
        .update({ title, menu_date })
        .eq("id", currentMenuId);

      if (error) { menuMetaMsg.textContent = "Error: " + error.message; return; }

      menuMetaMsg.textContent = "Guardado ✅";
      await loadMenus();
      menuHistory.value = String(currentMenuId);
    });

    // DELETE MENU
    document.getElementById("btnDeleteMenu").addEventListener("click", async () => {
      if (!menuHistory.value) return;
      const id = Number(menuHistory.value);

      const menu = cachedMenus.find(m => Number(m.id) === id);
      const label = `${menu?.menu_date ? menu.menu_date + " - " : ""}${menu?.title || ""}`;
      if (!confirm(`¿Seguro que quieres borrar este menú?\n\n${label}\n\n(No borra los platos del catálogo)`)) return;

      const { error } = await supabase.from("menus").delete().eq("id", id);
      if (error) { alert("Error: " + error.message); return; }

      currentMenuId = null;
      menuItemsList.innerHTML = `<span class="muted">Menú borrado.</span>`;
      await loadMenus();
    });

    // LOAD DISH CATALOG
    async function loadDishes() {
      const { data, error } = await supabase
        .from("menu_items")
        .select("id,name,category,description")
        .order("name", { ascending: true });

      if (error) { console.error(error); return; }
      cachedDishes = data || [];

      catalogSelect.innerHTML = cachedDishes.length
        ? `<option value="">(Elige un plato)</option>` + cachedDishes.map(d => {
            const label = `${d.name}${d.category ? " — " + d.category : ""}`;
            return `<option value="${d.id}">${esc(label)}</option>`;
          }).join("")
        : `<option value="">No hay platos en el catálogo</option>`;

      renderDishTable();
    }

    // CREATE DISH (NO mostramos ID en la UI)
    document.getElementById("btnCreateDish").addEventListener("click", async () => {
      dishMsg.textContent = "";
      const name = document.getElementById("dishName").value.trim();
      const category = document.getElementById("dishCategory").value.trim() || null;
      const description = document.getElementById("dishDesc").value.trim() || null;

      if (!name) { dishMsg.textContent = "Ponle nombre al plato."; return; }

      const { error } = await supabase
        .from("menu_items")
        .insert([{ name, category, description }]);

      if (error) { dishMsg.textContent = "Error: " + error.message; return; }

      dishMsg.textContent = "Plato creado ✅";
      document.getElementById("dishName").value = "";
      document.getElementById("dishCategory").value = "";
      document.getElementById("dishDesc").value = "";

      await loadDishes();
    });

    function renderDishTable() {
      if (!cachedDishes.length) {
        dishTable.innerHTML = `<div class="muted">No hay platos todavía.</div>`;
        return;
      }

      // NO mostramos ID
      dishTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Descripción</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${cachedDishes.map(d => `
              <tr>
                <td><strong>${esc(d.name)}</strong></td>
                <td>${esc(d.category || "-")}</td>
                <td>${esc(d.description || "")}</td>
                <td>
                  <button class="btn danger" data-del-dish="${d.id}">Borrar</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      dishTable.querySelectorAll("[data-del-dish]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = Number(btn.getAttribute("data-del-dish"));
          const dish = cachedDishes.find(x => Number(x.id) === id);
          if (!confirm(`¿Borrar plato "${dish?.name}"?\n(Ojo: si está usado en algún menú, no lo dejará borrar)`)) return;

          const { error } = await supabase.from("menu_items").delete().eq("id", id);
          if (error) { alert("Error: " + error.message); return; }
          await loadDishes();
          if (currentMenuId) await renderMenuItems(currentMenuId);
        });
      });
    }

    // MENU ITEMS LIST
    async function renderMenuItems(menuId) {
      const { data, error } = await supabase
        .from("menu_menu_items")
        .select("menu_id,item_id,sort_order, menu_items:menu_items(name,category,description)")
        .eq("menu_id", menuId)
        .order("sort_order", { ascending: true });

      if (error) { console.error(error); menuItemsList.textContent = "Error cargando platos."; return; }

      const rows = data || [];
      if (!rows.length) {
        menuItemsList.innerHTML = `<div class="muted">Este menú no tiene platos todavía.</div>`;
        return;
      }

      menuItemsList.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Orden</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Descripción</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${esc(r.sort_order)}</td>
                <td><strong>${esc(r.menu_items?.name || "")}</strong></td>
                <td>${esc(r.menu_items?.category || "-")}</td>
                <td>${esc(r.menu_items?.description || "")}</td>
                <td><button class="btn danger" data-remove-item="${r.item_id}">Quitar</button></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      menuItemsList.querySelectorAll("[data-remove-item]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const itemId = Number(btn.getAttribute("data-remove-item"));
          const { error } = await supabase
            .from("menu_menu_items")
            .delete()
            .eq("menu_id", menuId)
            .eq("item_id", itemId);

          if (error) { alert("Error: " + error.message); return; }
          await renderMenuItems(menuId);
        });
      });
    }

    // ADD ITEM TO MENU
    document.getElementById("btnAddItemToMenu").addEventListener("click", async () => {
      menuItemsMsg.textContent = "";
      if (!currentMenuId) { menuItemsMsg.textContent = "Selecciona un menú."; return; }

      const itemId = Number(catalogSelect.value);
      if (!itemId) { menuItemsMsg.textContent = "Elige un plato."; return; }

      const sort_order = Number(document.getElementById("sortOrder").value || 0);

      // upsert para que si ya está, actualice el orden
      const { error } = await supabase
        .from("menu_menu_items")
        .upsert([{ menu_id: currentMenuId, item_id: itemId, sort_order }], { onConflict: "menu_id,item_id" });

      if (error) { menuItemsMsg.textContent = "Error: " + error.message; return; }

      menuItemsMsg.textContent = "Agregado ✅";
      await renderMenuItems(currentMenuId);
    });

    async function reloadAll() {
      await loadMenus();
      await loadDishes();
      currentMenuId = null;
      menuItemsList.innerHTML = `<div class="muted">Selecciona un menú para gestionarlo.</div>`;
    }

    supabase.auth.onAuthStateChange(() => refreshAuthUI());
    refreshAuthUI();
  </script>
</body>
</html>
