<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Men√∫ Pro</title>
  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #f8fafc;
      --accent: #6366f1;
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 12px;
    }

    * { box-sizing: border-box; text-transform: uppercase; } /* Forzado visual global */
    
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* BARRA LATERAL */
    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
    }

    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid #1e293b;
    }

    .sidebar-header h1 {
      font-size: 18px;
      margin: 0;
      font-weight: 800;
      letter-spacing: 1px;
      color: var(--accent);
    }

    .menu-list-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .menu-item-btn {
      width: 100%;
      background: transparent;
      border: 1px solid #1e293b;
      color: #94a3b8;
      padding: 12px;
      border-radius: 8px;
      text-align: left;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 11px;
      display: flex;
      flex-direction: column;
    }

    .menu-item-btn:hover { background: #1e293b; color: white; }
    .menu-item-btn.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .menu-item-btn span { font-weight: 800; font-size: 13px; }
    .menu-item-btn small { opacity: 0.7; margin-top: 4px; }

    /* CONTENIDO PRINCIPAL */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: var(--bg);
    }

    .top-nav {
      background: var(--card);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .view-container { padding: 32px; max-width: 1400px; margin: 0 auto; width: 100%; }

    /* CARDS & GRIDS */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .grid-editor {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      gap: 24px;
    }

    /* FORMS */
    label {
      display: block;
      font-size: 11px;
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      background: #f8fafc;
      font-weight: 600;
    }

    input:focus { border-color: var(--accent); outline: none; background: white; }

    /* BUTTONS */
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 800;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: white;
    }

    .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-danger { background: white; color: var(--danger); border-color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }
    .btn-ghost { border: none; background: transparent; color: var(--muted); }

    /* TABLES */
    .table-container { overflow: hidden; border-radius: 8px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; background: white; }
    th { background: #f8fafc; padding: 14px; text-align: left; font-size: 10px; color: var(--muted); border-bottom: 1px solid var(--border); }
    td { padding: 14px; border-bottom: 1px solid var(--border); font-size: 13px; }

    /* UTILS */
    .hidden { display: none !important; }
    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; background: #e2e8f0; }

    /* LOGIN OVERLAY */
    #loginCard {
      position: fixed;
      inset: 0;
      background: var(--sidebar-bg);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-box { width: 400px; background: white; padding: 40px; border-radius: 20px; }

    @media (max-width: 1024px) {
      .grid-editor { grid-template-columns: 1fr; }
      .sidebar { width: 80px; }
      .sidebar span, .sidebar small, .sidebar-header h1 { display: none; }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginCard">
    <div class="login-box">
      <h2 style="margin-top:0; text-align:center; color: var(--sidebar-bg)">ADMIN ACCESO</h2>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="ADMIN@CORREO.COM" />
      <label>Contrase√±a</label>
      <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button class="btn btn-primary" id="btnLogin" style="width:100%; justify-content:center; margin-top:10px;">INICIAR SESI√ìN</button>
    </div>
  </div>

  <!-- APP STRUCTURE -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>MENU MANAGER</h1>
    </div>
    <div class="menu-list-container">
      <label style="color: #475569; margin-left: 12px;">HISTORIAL DE MEN√öS</label>
      <div id="menuButtonsList">
        <!-- Botones de men√∫ din√°micos aqu√≠ -->
      </div>
    </div>
    <div style="padding: 16px; border-top: 1px solid #1e293b;">
      <button class="btn btn-primary" id="btnSidebarNewMenu" style="width:100%">+ NUEVO MEN√ö</button>
    </div>
  </aside>

  <main class="main-content hidden" id="app">
    <div class="top-nav">
      <div>
        <span class="status-badge" id="menuStatus">SELECCIONA UN MEN√ö</span>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-ghost" id="btnLogout">CERRAR SESI√ìN</button>
      </div>
    </div>

    <div class="view-container">
      
      <!-- GESTI√ìN DEL MEN√ö SELECCIONADO -->
      <div class="card">
        <div style="display:flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
          <div style="flex:1; max-width: 400px; margin-right: 20px;">
            <label>NOMBRE DEL MEN√ö ACTUAL</label>
            <input id="menuName" placeholder="EJ: ALMUERZO EJECUTIVO" />
          </div>
          <div style="flex:1; max-width: 200px; margin-right: 20px;">
            <label>FECHA</label>
            <input id="menuDate" type="date" />
          </div>
          <div style="display:flex; gap:10px; padding-bottom: 16px;">
            <button class="btn btn-primary" id="btnUpdateMenu">GUARDAR CAMBIOS</button>
            <button class="btn btn-danger" id="btnDeleteMenu">ELIMINAR MEN√ö</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width:50px">#</th>
                <th>PLATO</th>
                <th>CATEGOR√çA</th>
                <th>DESCRIPCI√ìN</th>
                <th style="width:180px">ACCIONES</th>
              </tr>
            </thead>
            <tbody id="menuItemsTbody">
              <!-- Platos del men√∫ actual -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="grid-editor">
        <!-- EDITOR DE PLATO -->
        <div class="card">
          <h3 style="margin-top:0">EDITOR DE PLATO</h3>
          <input id="itemId" type="hidden" />
          
          <label>NOMBRE DEL PLATO</label>
          <input id="itemName" class="auto-caps" placeholder="EJ: MILANESA CON PAPAS" />

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label>CATEGOR√çA</label>
              <select id="itemCategory">
                <option value="">(SIN CATEGOR√çA)</option>
                <option value="ENTRADA">ENTRADA</option>
                <option value="PRINCIPAL">PRINCIPAL</option>
                <option value="POSTRE">POSTRE</option>
                <option value="BEBIDA">BEBIDA</option>
              </select>
            </div>
            <div>
              <label>FECHA PLATO (OPC.)</label>
              <input id="itemDate" type="date" />
            </div>
          </div>

          <label>DESCRIPCI√ìN / INGREDIENTES</label>
          <textarea id="itemDesc" class="auto-caps" style="height: 80px;" placeholder="CARNE RES, QUESO, TOMATE..."></textarea>

          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button class="btn btn-primary" id="btnSaveItem" style="flex:1">GUARDAR Y AGREGAR</button>
            <button class="btn" id="btnClearItem">LIMPIAR</button>
          </div>
        </div>

        <!-- HISTORIAL / BUSCADOR -->
        <div class="card">
          <h3 style="margin-top:0">BUSCAR EN HISTORIAL</h3>
          <div style="position: relative;">
            <input id="searchItems" placeholder="BUSCAR POR NOMBRE O CATEGOR√çA..." style="padding-left: 40px;" />
            <span style="position: absolute; left: 14px; top: 12px; opacity: 0.5;">üîç</span>
          </div>

          <div class="table-container" style="max-height: 350px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>PLATO</th>
                  <th>CAT.</th>
                  <th style="width:100px">ACCI√ìN</th>
                </tr>
              </thead>
              <tbody id="historyItemsTbody">
                <!-- Items del historial -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Dom Elements
    const loginCard = document.getElementById("loginCard");
    const app = document.getElementById("app");
    const menuButtonsList = document.getElementById("menuButtonsList");
    const menuItemsTbody = document.getElementById("menuItemsTbody");
    const historyItemsTbody = document.getElementById("historyItemsTbody");

    let currentMenuId = null;
    let menusCache = [];
    let historyCache = [];

    // --- LOGICA DE MAY√öSCULAS AUTOM√ÅTICAS ---
    document.querySelectorAll('input, textarea').forEach(el => {
      if(el.type !== 'password' && el.type !== 'date' && el.type !== 'email') {
        el.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
      }
    });

    function fmtDate(d) {
      if (!d) return "";
      const [y, m, dd] = d.split("-");
      return `${dd}/${m}/${y}`;
    }

    async function refreshAuthUI() {
      const { data } = await supabaseClient.auth.getSession();
      const loggedIn = !!data.session;
      loginCard.classList.toggle("hidden", loggedIn);
      app.classList.toggle("hidden", !loggedIn);

      if (loggedIn) {
        await loadMenus();
        await loadHistoryItems();
      }
    }

    // AUTH
    document.getElementById("btnLogin").onclick = async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPass").value;
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) alert("ERROR: " + error.message);
      else refreshAuthUI();
    };

    document.getElementById("btnLogout").onclick = async () => {
      await supabaseClient.auth.signOut();
      refreshAuthUI();
    };

    // MENUS
    async function loadMenus() {
      const { data } = await supabaseClient.from("menus").select("*").order("menu_date", { ascending: false });
      menusCache = data || [];
      renderMenuButtons();
    }

    function renderMenuButtons() {
      menuButtonsList.innerHTML = menusCache.map(m => `
        <button class="menu-item-btn ${currentMenuId == m.id ? 'active' : ''}" onclick="selectMenu(${m.id})">
          <span>${m.name || 'SIN NOMBRE'}</span>
          <small>${m.menu_date ? fmtDate(m.menu_date) : 'SIN FECHA'}</small>
        </button>
      `).join("");
    }

    window.selectMenu = async (id) => {
      currentMenuId = id;
      const m = menusCache.find(x => x.id === id);
      document.getElementById("menuName").value = m.name || "";
      document.getElementById("menuDate").value = m.menu_date || "";
      document.getElementById("menuStatus").textContent = `EDITANDO: ${m.name}`;
      renderMenuButtons();
      await loadMenuItems();
    };

    document.getElementById("btnSidebarNewMenu").onclick = async () => {
      const { data, error } = await supabaseClient.from("menus").insert([{ name: "NUEVO MEN√ö", menu_date: new Date().toISOString().split('T')[0] }]).select().single();
      if (!error) {
        await loadMenus();
        selectMenu(data.id);
      }
    };

    document.getElementById("btnUpdateMenu").onclick = async () => {
      if(!currentMenuId) return;
      const name = document.getElementById("menuName").value;
      const date = document.getElementById("menuDate").value;
      await supabaseClient.from("menus").update({ name, menu_date: date }).eq("id", currentMenuId);
      await loadMenus();
      alert("MEN√ö ACTUALIZADO");
    };

    document.getElementById("btnDeleteMenu").onclick = async () => {
      if(!currentMenuId || !confirm("¬øELIMINAR ESTE MEN√ö COMPLETAMENTE?")) return;
      await supabaseClient.from("menu_menu_items").delete().eq("menu_id", currentMenuId);
      await supabaseClient.from("menus").delete().eq("id", currentMenuId);
      currentMenuId = null;
      await loadMenus();
      location.reload();
    };

    // ITEMS
    async function loadHistoryItems() {
      const { data } = await supabaseClient.from("menu_items").select("*").order("created_at", { ascending: false });
      historyCache = data || [];
      renderHistory();
    }

    function renderHistory() {
      const q = document.getElementById("searchItems").value.toUpperCase();
      const filtered = historyCache.filter(i => (i.name||"").includes(q) || (i.category||"").includes(q));

      historyItemsTbody.innerHTML = filtered.map(i => `
        <tr>
          <td><b>${i.name}</b><br><small style="color:var(--muted)">${i.description || ''}</small></td>
          <td><span class="status-badge">${i.category || '-'}</span></td>
          <td>
            <div style="display:flex; gap:5px;">
              <button class="btn btn-primary" style="padding:5px 10px" onclick="addItemToMenu(${i.id})">+</button>
              <button class="btn btn-danger" style="padding:5px 10px" onclick="deleteFromHistory(${i.id})">√ó</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    document.getElementById("searchItems").oninput = renderHistory;

    async function loadMenuItems() {
      if (!currentMenuId) return;
      const { data } = await supabaseClient
        .from("menu_menu_items")
        .select("id, menu_items(id, name, category, description)")
        .eq("menu_id", currentMenuId);
      
      menuItemsTbody.innerHTML = (data || []).map((row, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td><b>${row.menu_items.name}</b></td>
          <td>${row.menu_items.category || ''}</td>
          <td>${row.menu_items.description || ''}</td>
          <td>
            <button class="btn btn-danger" onclick="removeItemFromMenu(${row.id})">QUITAR</button>
          </td>
        </tr>
      `).join("");
    }

    window.addItemToMenu = async (itemId) => {
      if(!currentMenuId) return alert("SELECCIONA UN MEN√ö PRIMERO");
      await supabaseClient.from("menu_menu_items").insert([{ menu_id: currentMenuId, menu_item_id: itemId }]);
      loadMenuItems();
    };

    window.removeItemFromMenu = async (linkId) => {
      await supabaseClient.from("menu_menu_items").delete().eq("id", linkId);
      loadMenuItems();
    };

    window.deleteFromHistory = async (id) => {
      if(!confirm("¬øBORRAR PLATO DEL HISTORIAL? SE QUITAR√Å DE TODOS LOS MEN√öS.")) return;
      await supabaseClient.from("menu_menu_items").delete().eq("menu_item_id", id);
      await supabaseClient.from("menu_items").delete().eq("id", id);
      await loadHistoryItems();
      await loadMenuItems();
    };

    document.getElementById("btnSaveItem").onclick = async () => {
      const name = document.getElementById("itemName").value;
      if(!name) return;
      const payload = {
        name,
        category: document.getElementById("itemCategory").value,
        description: document.getElementById("itemDesc").value,
        item_date: document.getElementById("itemDate").value || null
      };

      const { data, error } = await supabaseClient.from("menu_items").insert([payload]).select().single();
      if(!error) {
        if(currentMenuId) await addItemToMenu(data.id);
        await loadHistoryItems();
        document.getElementById("itemName").value = "";
        document.getElementById("itemDesc").value = "";
      }
    };

    document.getElementById("btnClearItem").onclick = () => {
      document.getElementById("itemId").value = "";
      document.getElementById("itemName").value = "";
      document.getElementById("itemDesc").value = "";
    };

    refreshAuthUI();
  </script>
</body>
</html>
