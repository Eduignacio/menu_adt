<!-- REEMPLAZA EL DIV id="viewCatalog" POR ESTE -->
<div id="viewCatalog" class="hidden">
    <div class="card" style="border-top: 4px solid var(--accent);">
        <div class="card-title">
            <span id="catIcon" style="font-size: 20px;">üìÇ</span> 
            <span id="catFormTitle" style="font-size: 14px; font-weight: 800; margin-left: 10px;">GESTI√ìN DEL CAT√ÅLOGO DE ALIMENTOS</span>
        </div>
        
        <!-- Formulario con Orientaci√≥n Horizontal -->
        <div class="horizontal-form">
            <input type="hidden" id="editCatId">
            
            <div class="form-row main-fields">
                <div class="input-group">
                    <label>CATEGOR√çA</label>
                    <input id="cCat" placeholder="EJ: ARROZ">
                </div>
                <div class="input-group">
                    <label>ACOMPA√ëAMIENTO</label>
                    <input id="cAcomp" placeholder="EJ: ARROZ BLANCO">
                </div>
            </div>

            <div class="form-row option-fields">
                <div class="input-group">
                    <label>OPCI√ìN 1</label>
                    <input id="cPollo" placeholder="PREPARACI√ìN 1">
                </div>
                <div class="input-group">
                    <label>OPCI√ìN 2</label>
                    <input id="cCerdo" placeholder="PREPARACI√ìN 2">
                </div>
                <div class="input-group">
                    <label>OPCI√ìN 3</label>
                    <input id="cCarne" placeholder="PREPARACI√ìN 3">
                </div>
                <div class="input-group">
                    <label>OPCI√ìN 4</label>
                    <input id="cOpc4" placeholder="PREPARACI√ìN 4">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end;">
                <button class="btn btn-ghost hidden" id="btnCancelCat" onclick="resetCatForm()">‚úï CANCELAR</button>
                <button class="btn btn-primary" id="btnSaveCat" onclick="saveFood()" style="min-width: 200px;">
                    <span id="btnTextCat">GUARDAR ALIMENTO</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Tabla de Alimentos -->
    <div class="card" style="padding: 0; overflow: hidden;">
        <div class="table-header">
            <h3 style="margin:0; font-size: 12px; color: var(--muted);">LISTADO DE ALIMENTOS DISPONIBLES</h3>
            <span id="catCounter" class="badge-count">0 ITEMS</span>
        </div>
        <div class="table-wrap" style="border: none; border-radius: 0;">
            <table>
                <thead>
                    <tr>
                        <th>CATEGOR√çA</th>
                        <th>ACOMPA√ëAMIENTO</th>
                        <th>OPCIONES CONFIGURADAS (1 / 2 / 3 / 4)</th>
                        <th style="text-align: right; width: 120px;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="catTableBody">
                    <!-- Din√°mico -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    /* Estilos para la orientaci√≥n horizontal */
    .horizontal-form { display: flex; flex-direction: column; gap: 20px; }
    .form-row { display: grid; gap: 15px; width: 100%; }
    .main-fields { grid-template-columns: 1fr 2fr; }
    .option-fields { grid-template-columns: 1fr 1fr 1fr 1fr; }
    
    .input-group { display: flex; flex-direction: column; }
    .table-header { padding: 20px 25px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .badge-count { font-size: 10px; background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-weight: 800; }

    @media (max-width: 900px) {
        .main-fields, .option-fields { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
        .main-fields, .option-fields { grid-template-columns: 1fr; }
    }
</style>

<script>
// --- ACTUALIZAR ESTAS FUNCIONES EN EL SCRIPT ---

async function loadCatTable() {
    const { data, error } = await sb.from('food_catalog').select('*').order('categoria');
    if (error) return;
    
    catalogCache = data || [];
    const container = document.getElementById('catTableBody');
    document.getElementById('catCounter').innerText = `${catalogCache.length} ITEMS`;

    container.innerHTML = catalogCache.map(i => `
        <tr>
            <td style="font-weight: 800; color: var(--accent);">${i.categoria}</td>
            <td style="font-weight: 700;">${i.acompanamiento}</td>
            <td style="font-size: 10px; color: var(--muted); text-transform: none;">
                ${i.pollo || '-'} / ${i.cerdo || '-'} / ${i.carne_roja || '-'} / ${i.opcion_4 || '-'}
            </td>
            <td style="text-align: right;">
                <button class="btn btn-warning btn-icon" onclick="editCat(${i.id})" style="padding:8px">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-icon" onclick="delCat(${i.id})" style="padding:8px">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');
}

async function saveFood() {
    const id = document.getElementById('editCatId').value;
    const btn = document.getElementById('btnSaveCat');
    
    const payload = {
        categoria: document.getElementById('cCat').value.toUpperCase().trim(),
        acompanamiento: document.getElementById('cAcomp').value.toUpperCase().trim(),
        pollo: document.getElementById('cPollo').value.toUpperCase().trim(),
        cerdo: document.getElementById('cCerdo').value.toUpperCase().trim(),
        carne_roja: document.getElementById('cCarne').value.toUpperCase().trim(),
        opcion_4: document.getElementById('cOpc4').value.toUpperCase().trim()
    };

    if (!payload.categoria || !payload.acompanamiento) return alert("COMPLETA CATEGOR√çA Y ACOMPA√ëAMIENTO");

    btn.disabled = true;
    btn.innerText = "GUARDANDO...";

    const { error } = id 
        ? await sb.from('food_catalog').update(payload).eq('id', id)
        : await sb.from('food_catalog').insert([payload]);

    if (error) {
        alert("ERROR: " + error.message);
    } else {
        alert("¬°CAT√ÅLOGO ACTUALIZADO! ‚úÖ");
        resetCatForm();
        loadCatTable();
        loadCatalog(); // Esto refresca el sidebar para que aparezca la Opci√≥n 4
    }
    btn.disabled = false;
    btn.innerText = id ? "ACTUALIZAR ALIMENTO" : "GUARDAR ALIMENTO";
}

// ACTUALIZA TAMBI√âN EL SIDEBAR PARA MOSTRAR LOS 4 BOTONES
async function loadCatalog() {
    const { data } = await sb.from('food_catalog').select('*').order('categoria');
    if (!data) return;
    const grouped = data.reduce((acc, i) => { (acc[i.categoria] = acc[i.categoria] || []).push(i); return acc; }, {});
    
    document.getElementById('catalogList').innerHTML = Object.keys(grouped).map(cat => `
        <div class="cat-accordion">
            <button class="cat-trigger" onclick="this.parentElement.classList.toggle('active')">${cat} <span>‚ñº</span></button>
            <div class="cat-content">
                ${grouped[cat].map(i => `
                    <div class="food-card">
                        <b>${i.acompanamiento}</b>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                            <button class="btn-quick" onclick="addD('${i.acompanamiento.replace(/'/g,"\\'")}','${i.pollo.replace(/'/g,"\\'")}','${cat}')">${i.pollo || 'OPC 1'}</button>
                            <button class="btn-quick" onclick="addD('${i.acompanamiento.replace(/'/g,"\\'")}','${i.cerdo.replace(/'/g,"\\'")}','${cat}')">${i.cerdo || 'OPC 2'}</button>
                            <button class="btn-quick" onclick="addD('${i.acompanamiento.replace(/'/g,"\\'")}','${i.carne_roja.replace(/'/g,"\\'")}','${cat}')">${i.carne_roja || 'OPC 3'}</button>
                            <button class="btn-quick" onclick="addD('${i.acompanamiento.replace(/'/g,"\\'")}','${i.opcion_4.replace(/'/g,"\\'")}','${cat}')">${i.opcion_4 || 'OPC 4'}</button>
                        </div>
                    </div>`).join('')}
            </div>
        </div>`).join('');
}

function editCat(id) {
    const i = catalogCache.find(x => x.id === id);
    document.getElementById('editCatId').value = i.id;
    document.getElementById('cCat').value = i.categoria;
    document.getElementById('cAcomp').value = i.acompanamiento;
    document.getElementById('cPollo').value = i.pollo;
    document.getElementById('cCerdo').value = i.cerdo;
    document.getElementById('cCarne').value = i.carne_roja;
    document.getElementById('cOpc4').value = i.opcion_4 || "";

    document.getElementById('catFormTitle').innerText = "EDITANDO ALIMENTO";
    document.getElementById('btnTextCat').innerText = "ACTUALIZAR ALIMENTO";
    document.getElementById('btnSaveCat').className = "btn btn-warning";
    document.getElementById('btnCancelCat').classList.remove('hidden');
    document.querySelector('.view-port').scrollTo({top: 0, behavior: 'smooth'});
}

function resetCatForm() {
    document.getElementById('editCatId').value = "";
    document.getElementById('cCat').value = "";
    document.getElementById('cAcomp').value = "";
    document.getElementById('cPollo').value = "";
    document.getElementById('cCerdo').value = "";
    document.getElementById('cCarne').value = "";
    document.getElementById('cOpc4').value = "";
    document.getElementById('catFormTitle').innerText = "A√ëADIR NUEVO ALIMENTO";
    document.getElementById('btnTextCat').innerText = "GUARDAR ALIMENTO";
    document.getElementById('btnSaveCat').className = "btn btn-primary";
    document.getElementById('btnCancelCat').classList.add('hidden');
}
</script>
