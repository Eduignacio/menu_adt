<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const S_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
  const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";

  // ✅ OJO: renombrado para evitar choque por doble declaración
  const sb = window.supabase.createClient(S_URL, S_KEY);

  let draft = [];

  const loginOverlay = document.getElementById('loginOverlay');
  const appMain = document.getElementById('appMain');
  const loginError = document.getElementById('loginError');

  function showError(msg) {
    loginError.style.display = 'block';
    loginError.textContent = msg;
  }
  function clearError() {
    loginError.style.display = 'none';
    loginError.textContent = '';
  }

  function openApp() {
    loginOverlay.classList.add('hidden');
    appMain.classList.remove('hidden');

    document.getElementById('menuDate').value = new Date().toISOString().split('T')[0];
    loadCatalog();
  }

  function closeApp() {
    loginOverlay.classList.remove('hidden');
    appMain.classList.add('hidden');
  }

  async function checkAuth() {
    const { data, error } = await sb.auth.getSession();
    if (error) {
      console.error("getSession error:", error);
      closeApp();
      return;
    }
    if (data.session) openApp();
    else closeApp();
  }

  document.getElementById('btnLogin').onclick = async () => {
    clearError();

    const email = document.getElementById('lEmail').value.trim();
    const password = document.getElementById('lPass').value;

    if (!email || !password) return showError("Completa email y contraseña.");

    const { data, error } = await sb.auth.signInWithPassword({ email, password });

    if (error) {
      console.error("LOGIN ERROR:", error);
      return showError(error.message);
    }

    if (data.session) openApp();
    else showError("No se pudo iniciar sesión (sin sesión). Revisa configuración Auth.");
  };

  document.getElementById('btnLogoutTop').onclick = async () => {
    await sb.auth.signOut();
    closeApp();
  };

  sb.auth.onAuthStateChange((_event, session) => {
    if (session) openApp();
    else closeApp();
  });

  async function loadCatalog() {
    const { data, error } = await sb.from('food_catalog').select('*').order('categoria');
    const list = document.getElementById('catalogList');

    if (error) {
      console.error("food_catalog error:", error);
      list.innerHTML = `<div style="color:#fff; font-size:12px;">Error cargando catálogo: ${error.message}</div>`;
      return;
    }

    const grouped = (data || []).reduce((acc, item) => {
      (acc[item.categoria] = acc[item.categoria] || []).push(item);
      return acc;
    }, {});

    const cats = Object.keys(grouped);
    if (cats.length === 0) {
      list.innerHTML = `<div style="color:#fff; font-size:12px;">No hay datos en food_catalog.</div>`;
      return;
    }

    list.innerHTML = cats.map(cat => `
      <div class="cat-group">
        <div class="cat-name">${cat}</div>
        ${grouped[cat].map(i => `
          <div class="food-card">
            <b>${i.acompanamiento ?? ""}</b>
            <div class="btn-grid">
              <button class="btn-quick" onclick="addPlate(${JSON.stringify(i.acompanamiento ?? "")}, ${JSON.stringify(i.pollo ?? "")}, ${JSON.stringify(cat)})">POLLO</button>
              <button class="btn-quick" onclick="addPlate(${JSON.stringify(i.acompanamiento ?? "")}, ${JSON.stringify(i.cerdo ?? "")}, ${JSON.stringify(cat)})">CERDO</button>
              <button class="btn-quick" onclick="addPlate(${JSON.stringify(i.acompanamiento ?? "")}, ${JSON.stringify(i.carne_roja ?? "")}, ${JSON.stringify(cat)})">CARNE</button>
            </div>
          </div>`).join('')}
      </div>`).join('');
  }

  window.addPlate = function(acomp, prote, cat) {
    draft.push({
      name: `${acomp} + ${prote}`.trim(),
      category: cat,
      description: `ACOMPAÑAMIENTO: ${acomp} | PROTEÍNA: ${prote}`
    });
    renderDraft();
  }

  function renderDraft() {
    const container = document.getElementById('platesDraft');
    container.innerHTML = draft.map((p, i) => `
      <div class="plate-item">
        <div>
          <b>${p.name}</b><br>
          <small style="color:#64748b">${p.category}</small>
        </div>
        <button class="btn btn-danger" style="padding:6px 10px" onclick="draft.splice(${i},1);renderDraft()">X</button>
      </div>`).join('');
  }

  document.getElementById('btnSaveFull').onclick = async () => {
    const name = document.getElementById('menuName').value;
    const date = document.getElementById('menuDate').value;

    if (!date || draft.length === 0) return alert("FALTA FECHA O SELECCIONAR PLATOS");

    const { data: menu, error: mErr } = await sb
      .from('menus')
      .insert([{ name, menu_date: date }])
      .select()
      .single();

    if (mErr) return alert("ERROR MENÚ: " + mErr.message);

    for (const p of draft) {
      const { data: item, error: iErr } = await sb
        .from('menu_items')
        .insert([p])
        .select()
        .single();

      if (iErr) return alert("ERROR PLATO: " + iErr.message);

      const { error: linkErr } = await sb
        .from('menu_menu_items')
        .insert([{ menu_id: menu.id, menu_item_id: item.id }]);

      if (linkErr) return alert("ERROR LINK: " + linkErr.message);
    }

    alert("MENÚ PUBLICADO EXITOSAMENTE");
    draft = [];
    renderDraft();
  };

  document.addEventListener('input', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      if (e.target.type !== 'email' && e.target.type !== 'password' && e.target.type !== 'date') {
        e.target.value = e.target.value.toUpperCase();
      }
    }
  });

  checkAuth();
</script>
