
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>ADT - ADMIN PANEL</title>
  <!-- Tipograf√≠a -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta Neon Breeze */
      --bg: #edf2f7;              /* fondo general */
      --surface: #f9fafb;         /* tarjetas */
      --text: #1f2937;            /* texto principal */
      --muted: #6b7280;           /* texto secundario */
      --border: #e5e7eb;          /* borde suave */
      --accent: #3b82f6;          /* azul primario */
      --accent-hover: #2563eb;    /* azul oscuro hover */
      --danger: #ef4444;          /* rojo peligro */
      --ok: #10b981;              /* verde ok */
      --warn: #f59e0b;            /* amarillo avisos */
      --radius: 16px;             /* radios redondeados */
      --shadow-1: 0 8px 18px rgba(31,41,55,.12);       /* sombra suave */
      --shadow-2: 0 18px 40px rgba(31,41,55,.18);      /* sombra profunda */
      --sidebar-bg: #0f172a;      /* sidebar oscuro */
      --sidebar-border: #23314d;  /* borde sidebar */
      --sidebar-text: #e5e7eb;

      /* Neumorphism: luces/sombras */
      --neo-up: #ffffff;
      --neo-down: #d6dae0;
    }

    *{box-sizing:border-box;font-family:'Inter',sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden}

    /* LOGIN */
    #loginOverlay{
      position:fixed;inset:0;background:linear-gradient(135deg,#e0e7ff,#fef3c7);
      display:flex;align-items:center;justify-content:center;padding:24px;z-index:9999;
    }
    .login-card{
      width:100%;max-width:380px;border-radius:20px;background:var(--surface);
      border:1px solid var(--border);box-shadow:var(--shadow-2);padding:26px;
    }
    .login-card h2{margin:0 0 16px;text-align:center;font-weight:800}
    .login-card label{font-size:10px;font-weight:900;color:var(--muted);margin:8px 0 6px;display:block}
    .login-card input{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;text-transform:none;font-weight:700}
    .btn-primary{width:100%;padding:12px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer}
    .btn-primary:hover{background:var(--accent-hover)}

    /* SIDEBAR */
    .sidebar{
      width:320px;background:var(--sidebar-bg);color:var(--sidebar-text);
      display:flex;flex-direction:column;height:100vh;border-right:1px solid var(--sidebar-border);
      overflow-y:auto
    }
    .sidebar-brand{position:sticky;top:0;background:var(--sidebar-bg);padding:18px 20px;border-bottom:1px solid var(--sidebar-border);z-index:2}
    .sidebar-brand h2{margin:0;font-size:16px;letter-spacing:2px}
    .sidebar-nav{padding:12px;display:grid;gap:10px}
    .nav-section{border:1px solid var(--sidebar-border);border-radius:14px;overflow:hidden}
    .nav-section-title{padding:10px 12px;font-size:10px;color:#93a2b7;background:#0b1326}
    .nav-btn{
      width:100%;text-align:left;padding:12px 14px;border:none;background:transparent;color:#cbd5e1;
      font-weight:800;font-size:11px;cursor:pointer
    }
    .nav-btn:hover{background:#0b1326}
    .nav-btn.active{background:#16213a;color:#fff;border-left:4px solid var(--accent)}

    /* Constructor extras en sidebar */
    .search-cat{position:sticky;top:60px;background:#0b1326;padding:12px;z-index:1}
    .search-cat input{
      width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#13203f;color:#fff;
      font-size:11px;text-transform:none
    }
    .catalog-scroll{
      flex:1;padding:12px;background:#0f172a;overflow-y:auto;max-height:calc(100vh - 160px);
      scrollbar-color:#334155 transparent;scrollbar-width:thin
    }
    .catalog-scroll::-webkit-scrollbar{width:8px}
    .catalog-scroll::-webkit-scrollbar-thumb{background:#334155;border-radius:8px}
    .cat-accordion{border:1px solid #1f2937;border-radius:12px;overflow:hidden;margin-bottom:10px}
    .cat-trigger{width:100%;padding:12px;border:none;background:#13203f;color:#fff;font-weight:800;display:flex;justify-content:space-between;cursor:pointer}
    .cat-trigger:hover{background:#1a2a52}
    .cat-content{max-height:0;overflow:hidden;transition:max-height .3s ease;background:#0f172a}
    .cat-accordion.active .cat-content{max-height:2000px;padding:10px 8px}
    .food-card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px;margin:8px}
    .food-card b{display:block;color:#94a3b8;font-size:11px;margin-bottom:10px}
    .btn-grid-4{display:grid;grid-template-columns: 1fr 1fr;gap:6px}
    .btn-quick{padding:10px;border-radius:10px;border:1px solid #334155;background:#1f2937;color:#fff;font-weight:800;font-size:10px;cursor:pointer}
    .btn-quick:hover{background:var(--accent);border-color:var(--accent)}

    /* MAIN */
    .main-area{flex:1;display:flex;flex-direction:column}
    .top-bar{
      background:var(--surface);border-bottom:1px solid var(--border);padding:14px 22px;
      display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:5
    }
    .btn-toggle{
      width:42px;height:42px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(145deg,var(--neo-up),var(--neo-down));box-shadow:6px 6px 12px #cfd3da,-6px -6px 12px #ffffff;
      display:flex;align-items:center;justify-content:center;color:#374151;cursor:pointer
    }
    .view-port{flex:1;overflow-y:auto;padding:28px}
    .container{max-width:1100px;margin:0 auto}

    /* Cards + Inputs (neumorphism suave) */
    .card{
      background:linear-gradient(145deg,var(--surface),#eef1f5);
      border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-1)
    }
    label{font-size:10px;font-weight:900;color:var(--muted);margin-bottom:6px;display:block}
    input,select{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-weight:800
    }

    /* Tabs de modo */
    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
    .tab-btn{
      padding:14px;border-radius:14px;border:1px solid var(--border);background:#f3f4f6;color:var(--text);font-weight:900;cursor:pointer;text-align:center
    }
    .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

    /* Men√∫s guardados r√°pidos (chips con scroll horizontal) */
    .quick-row{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px}
    .quick-row::-webkit-scrollbar{height:8px}
    .quick-row::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:8px}
    .quick-chip{
      flex:0 0 auto;padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;font-weight:900;font-size:11px;display:flex;gap:8px;align-items:center;cursor:pointer;
      box-shadow: 6px 6px 14px #d8dbe1,-6px -6px 14px #fff
    }
    .quick-chip .date{color:var(--muted);font-size:10px;font-weight:800}

    /* Smart builder (manual) */
    .smart-header{font-weight:800;font-size:12px;color:var(--accent);margin-bottom:8px}
    .smart-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    @media (max-width:900px){.smart-grid{grid-template-columns:1fr}}
    .smart-input-row{display:flex;gap:8px;align-items:center;position:relative}
    .smart-btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);
      font-weight:900;font-size:11px;cursor:pointer;box-shadow: 6px 6px 14px #d8dbe1,-6px -6px 14px #fff
    }
    .smart-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:none}
    .smart-btn.primary:hover{background:var(--accent-hover)}
    .smart-btn.danger{background:#fee2e2;color:var(--danger);border-color:#fecaca;box-shadow:none}
    .smart-help{font-size:10px;color:var(--muted);text-transform:none;margin-top:4px}

    /* Typeahead */
    .typeahead{
      position:absolute;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--border);
      border-radius:12px;box-shadow:var(--shadow-2);z-index:50;max-height:240px;overflow-y:auto
    }
    .typeahead.hidden{display:none}
    .type-item{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:800;font-size:12px;color:var(--text)}
    .type-item .hint{font-size:10px;color:var(--muted)}
    .type-item:hover,.type-item.active{background:#eef2ff;color:var(--accent)}

    /* Chips borrador */
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-size:12px;font-weight:900;box-shadow: 6px 6px 14px #d8dbe1,-6px -6px 14px #fff
    }
    .chip .cat{font-size:10px;color:var(--muted)}
    .chip .chip-btn{border:none;background:transparent;font-weight:900;font-size:11px;color:var(--muted);cursor:pointer}
    .chip .chip-btn:hover{color:var(--accent)}
    .chip.dragging{opacity:.65;transform:scale(.98)}

    .btn-publish{
      width:100%;padding:16px;border-radius:14px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;box-shadow:var(--shadow-1)
    }
    .btn-publish:hover{background:var(--accent-hover)}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0f172a;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow-2);
      font-weight:900;font-size:12px;z-index:9999
    }
    .toast.hidden{display:none}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginOverlay">
    <div class="login-card">
      <h2>ADT ADMIN</h2>
      <label>EMAIL</label><input id="lEmail" type="email" placeholder="usuario@ejemplo.com">
      <label>PASSWORD</label><input id="lPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button class="btn-primary" onclick="handleLogin()">ENTRAR</button>
      <p id="loginMsg" style="color:var(--danger);font-size:10px;text-align:center;margin-top:10px;text-transform:none;display:none;"></p>
    </div>
  </div>

  <!-- APP -->
  <div id="appMain" class="hidden" style="display:flex;width:100%;">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-brand"><h2>MENU SYSTEM</h2></div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">üõ† CONSTRUCTOR</div>
          <button class="nav-btn active" id="navB" onclick="switchView('builder')">MEN√ö</button>
          <button class="nav-btn" id="navH" onclick="switchView('history')">HISTORIAL</button>
        </div>
        <div class="nav-section hidden" id="adminSection">
          <div class="nav-section-title">üîí ADMINISTRADOR</div>
          <button class="nav-btn hidden" id="navC" onclick="switchView('catalog')">ALIMENTOS</button>
          <button class="nav-btn hidden" id="navU" onclick="switchView('users')">USUARIOS</button>
        </div>
      </nav>

      <!-- Extras del CONSTRUCTOR -->
      <div id="builderSidebarExtras">
        <div class="search-cat"><input id="catSearch" placeholder="üîç BUSCAR..." oninput="filterCat()"></div>
        <div id="catalogList" class="catalog-scroll"></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-area">
      <header class="top-bar">
        <div style="display:flex;align-items:center;gap:12px;">
          <button class="btn-toggle">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
          </button>
          <h1 id="viewTitle" style="font-size:14px;margin:0;font-weight:800;">üõ† CONSTRUCTOR</h1>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span id="userBadge" style="font-size:10px;font-weight:900;color:var(--accent);text-transform:lowercase;"></span>
          <button onclick="handleLogout()" class="smart-btn">SALIR</button>
        </div>
      </header>

      <section class="view-port">
        <div class="container">

          <!-- CONSTRUCTOR -->
          <div id="viewBuilder">
            <div class="card">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                <div><label>FECHA DEL MEN√ö</label><input id="menuDate" type="date"></div>
                <div><label>NOMBRE DEL MEN√ö</label><input id="menuName" placeholder="EJ: MEN√ö DEL D√çA"></div>
              </div>

              <!-- Men√∫s guardados r√°pidos -->
              <div style="margin-top:10px;">
                <label>MEN√öS GUARDADOS (R√ÅPIDO)</label>
                <div id="quickRow" class="quick-row"></div>
              </div>

              <!-- Tabs modo -->
              <div class="tabs" style="margin-top:10px;">
                <button id="tabCatalog" class="tab-btn active" onclick="setBuilderMode('catalog')">üìÇ CAT√ÅLOGO</button>
                <button id="tabManual"  class="tab-btn"        onclick="setBuilderMode('manual')">‚úçÔ∏è MANUAL</button>
              </div>

              <!-- Manual -->
              <div id="manualCard" class="card" style="margin-top:8px;display:none;">
                <div class="smart-header">MEN√ö MANUAL</div>
                <div class="smart-grid">
                  <div>
                    <label>ESCRIBIR PLATO</label>
                    <div class="smart-input-row">
                      <input id="typedDish" class="smart-input" placeholder="EJ: LASA√ëA DE CARNE">
                      <button class="smart-btn primary" id="btnAddDish">AGREGAR</button>
                      <button class="smart-btn" id="btnClearDish">LIMPIAR</button>
                      <div id="typeahead" class="typeahead hidden"></div>
                    </div>
                    <div class="smart-help">Enter: agrega/selecciona ¬∑ Esc: limpia ¬∑ se agrega en MAY√öSCULAS.</div>
                  </div>
                  <div>
                    <label>CATEGOR√çA</label>
                    <div class="smart-input-row">
                      <select id="typedCategory" class="smart-input"></select>
                      <button class="smart-btn" id="btnRefreshCats">‚Üª</button>
                    </div>
                    <div class="smart-help">Elige una categor√≠a o usa LIBRE.</div>
                  </div>
                  <div>
                    <label>GESTI√ìN DE MEN√öS</label>
                    <div class="smart-input-row wrap">
                      <select id="savedSelect" class="smart-input"></select>
                      <button class="smart-btn" onclick="saveCurrentMenu()">GUARDAR</button>
                      <button class="smart-btn" onclick="loadSelectedMenu()">CARGAR</button>
                      <button class="smart-btn" onclick="renameSelectedMenu()">RENOMBRAR</button>
                      <button class="smart-btn" onclick="duplicateSelectedMenu()">DUPLICAR</button>
                      <button class="smart-btn danger" onclick="deleteSelectedMenu()">BORRAR</button>
                    </div>
                  </div>
                </div>

                <div style="margin-top:10px;">
                  <label>BORRADOR DEL MEN√ö</label>
                  <div id="draftChips" class="chips"></div>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px;">
                  <button class="smart-btn" id="btnClearDraft">LIMPIAR BORRADOR</button>
                  <button class="smart-btn" id="btnSortDraft">ORDENAR A-Z</button>
                  <button class="smart-btn" id="btnExportDraft">COPIAR TEXTO</button>
                </div>
              </div>

              <button class="btn-publish" style="margin-top:12px;" onclick="publishMenu()">PUBLICAR AHORA</button>
            </div>
          </div>

          <!-- HISTORIAL -->
          <div id="viewHistory" class="hidden">
            <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
              <button onclick="delAllMenus()" class="smart-btn danger">üóëÔ∏è BORRAR TODO EL HISTORIAL</button>
            </div>
            <div class="card"><table id="historyTable" style="width:100%"></table></div>
          </div>

          <!-- ADMIN: CATALOGO -->
          <div id="viewCatalog" class="hidden">
            <div class="card">
              <div class="smart-header">GESTI√ìN DEL CAT√ÅLOGO</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                <input type="hidden" id="editCatId">
                <div><label>CATEGOR√çA</label><input id="cCat" placeholder="EJ: ARROZ"></div>
                <div><label>ACOMPA√ëAMIENTO</label><input id="cAcomp" placeholder="EJ: ARROZ BLANCO"></div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:10px;">
                <div><label>OPCI√ìN 1</label><input id="cOpc1"></div>
                <div><label>OPCI√ìN 2</label><input id="cOpc2"></div>
                <div><label>OPCI√ìN 3</label><input id="cOpc3"></div>
                <div><label>OPCI√ìN 4</label><input id="cOpc4"></div>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="smart-btn" id="btnCancelCat" onclick="resetCatForm()" style="display:none;">‚úï CANCELAR</button>
                <button class="smart-btn primary" onclick="saveFood()">GUARDAR ALIMENTO</button>
              </div>
            </div>
            <div class="card">
              <table style="width:100%;">
                <thead><tr><th style="text-align:left;">CAT.</th><th style="text-align:left;">ACOMPA√ëAMIENTO</th><th style="text-align:right;">ACCI√ìN</th></tr></thead>
                <tbody id="catTable"></tbody>
              </table>
            </div>
          </div>

          <!-- ADMIN: USUARIOS -->
          <div id="viewUsers" class="hidden">
            <div class="card">
              <div class="smart-header">USUARIOS</div>
              <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end;">
                <input type="hidden" id="uId">
                <div><label>EMAIL</label><input id="uEmail" type="email" style="text-transform:none !important;"></div>
                <div><label>PASSWORD</label><input id="uPass" type="password" style="text-transform:none !important;"></div>
                <div style="display:flex;gap:10px;align-items:center;">
                  <label style="font-size:10px;"><input type="checkbox" id="pCat"> CAT.</label>
                  <label style="font-size:10px;"><input type="checkbox" id="pUsr"> USR.</label>
                  <button class="smart-btn primary" onclick="saveUsr()">GUARDAR</button>
                </div>
              </div>
            </div>
            <div class="card"><table id="usrTable" style="width:100%"></table></div>
          </div>

        </div>
      </section>
    </main>
  </div>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* Supabase */
    const S_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    /* Estado */
    let perms = { cat:false, usr:false };
    let catalogCache = [];
    let draft = [];
    let savedMenus = [];
    let typeList = [];
    let taActive = -1;

    /* Utilidades */
    const toUpper = s => (s || '').trim().toUpperCase();
    const esc = s => (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":"&#39;"}[c]));
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500); }

    /* Auth/Permisos */
    async function handleLogin(){
      const { error } = await sb.auth.signInWithPassword({ email:lEmail.value.trim().toLowerCase(), password:lPass.value });
      if (error){ loginMsg.textContent = "ERROR: " + error.message; loginMsg.style.display='block'; } else location.reload();
    }
    function handleLogout(){ sb.auth.signOut(); localStorage.clear(); location.reload(); }
    async function check(){
      const { data:{ session } } = await sb.auth.getSession();
      if (session){
        const email = session.user.email.toLowerCase();
        userBadge.textContent = email;
        if (email === "eduardoignacio.g.h@gmail.com"){ perms.cat=true; perms.usr=true; } // UI hint
        const { data: db } = await sb.from('user_permissions').select('*').eq('email', email).maybeSingle();
        if (db){ perms.cat = db.can_manage_catalog || perms.cat; perms.usr = db.can_manage_users || perms.usr; }
        loginOverlay.style.display='none'; appMain.classList.remove('hidden');
        applyUiPermissions(); loadCatalogPicker();
      }
    }
    function applyUiPermissions(){
      const showAdmin = !!(perms.cat || perms.usr);
      adminSection.classList.toggle('hidden', !showAdmin);
      navC.classList.toggle('hidden', !perms.cat);
      navU.classList.toggle('hidden', !perms.usr);
    }

    /* Navegaci√≥n */
    function switchView(v){
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.view-port .container > div').forEach(d=>d.classList.add('hidden'));
      ({builder:'navB',history:'navH',catalog:'navC',users:'navU'}[v] && document.getElementById({builder:'navB',history:'navH',catalog:'navC',users:'navU'}[v]).classList.add('active'));
      document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).classList.remove('hidden');
      viewTitle.textContent = {builder:'üõ† CONSTRUCTOR',history:'üìú HISTORIAL',catalog:'üìÇ ALIMENTOS',users:'üë• USUARIOS'}[v];
      builderSidebarExtras.style.display = (v==='builder' && tabCatalog.classList.contains('active')) ? 'block' : 'none';
      if (v==='history') loadHistory();
      if (v==='catalog') loadCatTable();
      if (v==='users') loadUsrTable();
    }
    function setBuilderMode(mode){
      const showCatalog = (mode==='catalog');
      tabCatalog.classList.toggle('active', showCatalog);
      tabManual.classList.toggle('active', !showCatalog);
      builderSidebarExtras.style.display = showCatalog ? 'block' : 'none';
      manualCard.style.display = showCatalog ? 'none' : 'block';
      if (!showCatalog) typedDish.focus();
    }

    /* Guardados */
    function cryptoId(){ return 'm_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function loadSavedMenus(){
      try{ savedMenus = JSON.parse(localStorage.getItem('savedMenus')||'[]'); }catch{ savedMenus=[]; }
      renderSavedSelect(); renderQuickMenus();
    }
    function persistSavedMenus(){ localStorage.setItem('savedMenus', JSON.stringify(savedMenus)); }
    function currentMenuName(){ return (menuName.value ? menuName.value : 'MEN√ö DEL D√çA').toUpperCase(); }
    function renderSavedSelect(){
      savedSelect.innerHTML = savedMenus.length
        ? savedMenus.map(m=>`<option value="${m.id}">${esc(m.name)} - ${m.menu_date}</option>`).join('')
        : `<option value="">(sin men√∫s guardados)</option>`;
    }
    function renderQuickMenus(){
      const sorted=[...savedMenus].sort((a,b)=>new Date(b.createdAt||b.menu_date)-new Date(a.createdAt||a.menu_date));
      const top=sorted.slice(0,8);
      quickRow.innerHTML = top.length
        ? top.map(m=>`<div class="quick-chip" onclick="loadQuickMenu('${m.id}')"><span>${esc(m.name)}</span><span class="date">${esc(m.menu_date)}</span></div>`).join('')
        : `<div style="color:var(--muted);font-size:10px;font-weight:900;">No hay men√∫s guardados a√∫n.</div>`;
    }
    function loadQuickMenu(id){
      const m = savedMenus.find(x=>x.id===id); if (!m) return showToast('Men√∫ no encontrado');
      menuName.value=m.name; menuDate.value=m.menu_date; draft=m.items.slice(); renderDraftChips(); setBuilderMode('manual'); showToast('Men√∫ cargado');
    }
    function saveCurrentMenu(){
      if (!menuDate.value) return showToast('Selecciona fecha');
      if (!draft.length) return showToast('Agrega platos');
      const entry={ id:cryptoId(), name:currentMenuName(), menu_date:menuDate.value, items:draft.slice(), createdAt:new Date().toISOString() };
      savedMenus.push(entry); persistSavedMenus(); renderSavedSelect(); renderQuickMenus(); showToast('Guardado');
    }
    function loadSelectedMenu(){
      const m = savedMenus.find(x=>x.id===savedSelect.value); if (!m) return showToast('Selecciona un men√∫');
      menuName.value=m.name; menuDate.value=m.menu_date; draft=m.items.slice(); renderDraftChips(); setBuilderMode('manual'); showToast('Cargado');
    }
    function renameSelectedMenu(){
      const m = savedMenus.find(x=>x.id===savedSelect.value); if (!m) return showToast('Selecciona un men√∫');
      const n = prompt('Nuevo nombre del men√∫:', m.name); if (!n) return; m.name=n.toUpperCase();
      persistSavedMenus(); renderSavedSelect(); renderQuickMenus(); showToast('Renombrado');
    }
    function duplicateSelectedMenu(){
      const m = savedMenus.find(x=>x.id===savedSelect.value); if (!m) return showToast('Selecciona un men√∫');
      const copy={...m,id:cryptoId(),name:`${m.name} (COPIA)`,createdAt:new Date().toISOString()};
      savedMenus.push(copy); persistSavedMenus(); renderSavedSelect(); renderQuickMenus(); showToast('Duplicado');
    }
    function deleteSelectedMenu(){
      const id=savedSelect.value; if(!id) return showToast('Selecciona un men√∫');
      if(!confirm('¬øBorrar este men√∫ guardado?')) return;
      savedMenus=savedMenus.filter(x=>x.id!==id); persistSavedMenus(); renderSavedSelect(); renderQuickMenus(); showToast('Borrado');
    }

    /* Cat√°logo */
    async function loadCatalogPicker(){
      const { data } = await sb.from('food_catalog').select('*').order('categoria');
      catalogCache = data || []; renderCatalogList(catalogCache); fillTypedCategory(); rebuildTypeaheadSource();
    }
    function renderCatalogList(items){
      const grouped=items.reduce((acc,i)=>{(acc[i.categoria]=acc[i.categoria]||[]).push(i);return acc;}, {});
      catalogList.innerHTML = Object.keys(grouped).map(cat=>`
        <div class="cat-accordion">
          <button class="cat-trigger" onclick="this.parentElement.classList.toggle('active')">${esc(cat)} <span>‚ñº</span></button>
          <div class="cat-content">
            ${grouped[cat].map(i=>`
              <div class="food-card">
                <b>${esc(i.acompanamiento)}</b>
                <div class="btn-grid-4">
                  <button class="btn-quick" onclick="quickAdd('${esc(i.acompanamiento)}','${esc(i.pollo||'')}','${esc(cat)}')">${esc(i.pollo||'-')}</button>
                  <button class="btn-quick" onclick="quickAdd('${esc(i.acompanamiento)}','${esc(i.cerdo||'')}','${esc(cat)}')">${esc(i.cerdo||'-')}</button>
                  <button class="btn-quick" onclick="quickAdd('${esc(i.acompanamiento)}','${esc(i.carne_roja||'')}','${esc(cat)}')">${esc(i.carne_roja||'-')}</button>
                  <button class="btn-quick" onclick="quickAdd('${esc(i.acompanamiento)}','${esc(i.opcion_4||'')}','${esc(cat)}')">${esc(i.opcion_4||'-')}</button>
                </div>
              </div>`).join('')}
          </div>
        </div>`).join('');
    }
    function filterCat(){
      const q=toUpper(catSearch.value); const norm=s=>toUpper(s||'');
      const filtered=catalogCache.filter(f=>norm(f.acompanamiento).includes(q)||norm(f.categoria).includes(q));
      renderCatalogList(filtered); if(q) document.querySelectorAll('.cat-accordion').forEach(a=>a.classList.add('active'));
    }
    function quickAdd(a,p,c){
      if(!p||p==='-')return;
      const name=`${toUpper(a)} + ${toUpper(p)}`;
      if(draft.some(d=>d.name===name&&toUpper(d.category)===toUpper(c))) return showToast('Ya est√° en borrador');
      draft.push({name,category:toUpper(c),description:`BASE: ${a} | PREP: ${p}`});
      renderDraftChips(); setBuilderMode('manual'); showToast('Agregado desde cat√°logo');
    }

    /* Typeahead */
    function fillTypedCategory(){
      const cats=[...new Set((catalogCache||[]).map(i=>toUpper(i.categoria)))].sort();
      typedCategory.innerHTML = `<option value="LIBRE">LIBRE</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
    }
    function rebuildTypeaheadSource(){
      typeList=[]; for(const i of catalogCache){
        const base=toUpper(i.acompanamiento); const cat=toUpper(i.categoria);
        const opts=[i.pollo,i.cerdo,i.carne_roja,i.opcion_4].filter(x=>x&&x!=='-');
        for(const o of opts){ const option=toUpper(o); typeList.push({name:`${base} + ${option}`,category:cat,base,option}); }
      }
      const seen=new Set(); typeList=typeList.filter(s=>!seen.has(s.name)&&seen.add(s.name));
    }
    function updateTypeahead(){
      const q=toUpper(typedDish.value); const cat=toUpper(typedCategory.value||'LIBRE');
      if(!q){ hideTypeahead(); return; }
      let list=typeList.filter(s=>s.name.includes(q)||s.base.includes(q)||s.option.includes(q));
      if(cat!=='LIBRE') list=list.filter(s=>s.category===cat);
      const starts=list.filter(s=>s.name.startsWith(q)), contains=list.filter(s=>!s.name.startsWith(q));
      renderTypeahead([...starts,...contains].slice(0,10));
    }
    function renderTypeahead(results){
      typeahead.innerHTML=''; taActive=-1; if(!results.length){ hideTypeahead(); return; }
      results.forEach((s,idx)=>{
        const el=document.createElement('div');
        el.className='type-item'; el.innerHTML=`<span>${esc(s.name)}</span><span class="hint">${esc(s.category)}</span>`;
        el.addEventListener('mouseenter',()=>setActive(idx)); el.addEventListener('click',()=>chooseSuggestion(s));
        typeahead.appendChild(el);
      });
      setActive(0); typeahead.classList.remove('hidden');
    }
    function setActive(idx){
      const items=[...typeahead.querySelectorAll('.type-item')]; items.forEach(it=>it.classList.remove('active'));
      taActive=idx; if(items[idx]) items[idx].classList.add('active');
    }
    function moveActive(delta){
      const items=[...typeahead.querySelectorAll('.type-item')]; if(!items.length) return;
      let next=taActive+delta; if(next<0) next=items.length-1; if(next>=items.length) next=0; setActive(next); items[next].scrollIntoView({block:'nearest'});
    }
    function chooseActive(){
      const items=[...typeahead.querySelectorAll('.type-item')]; if(!items.length) return addTypedDish();
      const text=items[taActive]?.querySelector('span')?.textContent||''; const s=typeList.find(t=>t.name===text);
      if(s) chooseSuggestion(s); else addTypedDish();
    }
    function chooseSuggestion(s){
      if(draft.some(d=>d.name===s.name&&toUpper(d.category)===s.category)){ hideTypeahead(); typedDish.value=''; return showToast('Ya est√° en borrador'); }
      draft.push({name:s.name,category:s.category,description:`BASE: ${s.base} | PREP: ${s.option}`});
      typedCategory.value=s.category; renderDraftChips(); hideTypeahead(); typedDish.value=''; showToast('Agregado (sugerencia)');
    }
    function hideTypeahead(){ typeahead.classList.add('hidden'); taActive=-1; typeahead.innerHTML=''; }

    /* Borrador */
    function addTypedDish(){
      const name=toUpper(typedDish.value); if(!name){ typedDish.focus(); return showToast('Escribe un plato'); }
      const cat=toUpper(typedCategory.value||'LIBRE');
      if(draft.some(d=>d.name===name&&toUpper(d.category)===cat)){ typedDish.value=''; return showToast('Ya est√° en borrador'); }
      draft.push({name,category:cat,description:`${cat}: ${name}`}); typedDish.value=''; renderDraftChips(); showToast('Agregado');
    }
    function renderDraftChips(){
      draftChips.innerHTML = draft.map((p,i)=>`
        <div class="chip" draggable="true" data-index="${i}">
          <span>${esc(p.name)}</span><span class="cat">(${esc(p.category)})</span>
          <button class="chip-btn" onclick="inlineEdit(${i})">‚úèÔ∏è</button>
          <button class="chip-btn" onclick="dupDraft(${i})">üëØ</button>
          <button class="chip-btn" onclick="removeDraft(${i})">‚úï</button>
        </div>`).join('');
      draftChips.querySelectorAll('.chip').forEach(chip=>{
        chip.addEventListener('dragstart',()=>chip.classList.add('dragging'));
        chip.addEventListener('dragend',()=>chip.classList.remove('dragging'));
        chip.addEventListener('dragover',e=>{
          e.preventDefault(); const fromEl=draftChips.querySelector('.dragging'); if(!fromEl) return;
          const from=Number(fromEl.dataset.index), to=Number(chip.dataset.index);
          if(Number.isInteger(from)&&Number.isInteger(to)&&from!==to){ const tmp=draft[from]; draft[from]=draft[to]; draft[to]=tmp; renderDraftChips(); }
        });
      });
    }
    function inlineEdit(i){
      const nn=prompt('Editar plato:', draft[i].name); if(!nn) return;
      const up=toUpper(nn);
      if(draft.some((d,idx)=>d.name===up&&toUpper(d.category)===toUpper(draft[i].category)&&idx!==i)) return showToast('Nombre duplicado');
      draft[i].name=up; renderDraftChips();
    }
    function dupDraft(i){
      const copy={...draft[i]}; let name=copy.name;
      if(draft.some(d=>d.name===name&&toUpper(d.category)===toUpper(copy.category))) name=`${name} (COPIA)`;
      copy.name=name; draft.push(copy); renderDraftChips();
    }
    function removeDraft(i){ draft.splice(i,1); renderDraftChips(); }
    function clearDraft(){ if(!draft.length)return; if(!confirm('¬øLimpiar borrador?'))return; draft=[]; renderDraftChips(); showToast('Borrador limpio'); }
    function sortDraftAZ(){ draft.sort((a,b)=>a.name.localeCompare(b.name,'es')); renderDraftChips(); }
    function exportDraftText(){ const text=draft.map(x=>`‚Ä¢ ${x.category}: ${x.name}`).join('\n'); navigator.clipboard.writeText(text).then(()=>showToast('Copiado')); }

    /* Publicar */
    async function publishMenu(){
      if(!menuDate.value||!draft.length) return alert("FALTA INFO");
      const menuTitle=currentMenuName();
      const { data:m, error } = await sb.from('menus').insert([{ name:menuTitle, menu_date:menuDate.value }]).select().single();
      if(error||!m) return alert("No se pudo publicar: "+(error?.message||'Error'));
      for(const p of draft){
        const { data:item, error:eItem } = await sb.from('menu_items').insert([p]).select().single();
        if(eItem||!item){ alert("Error item: "+(eItem?.message||'Error')); continue; }
        await sb.from('menu_menu_items').insert([{ menu_id:m.id, menu_item_id:item.id }]);
      }
      alert("PUBLICADO ‚úÖ"); draft=[]; renderDraftChips();
    }

    /* Historial */
    async function loadHistory(){
      const { data } = await sb.from('menus').select('id, name, menu_date, menu_menu_items(menu_items(name, category))').order('menu_date',{ascending:false});
      historyTable.innerHTML = (data||[]).map(m=>{
        const pts=m.menu_menu_items.map(rel=>rel.menu_items?`<span style="display:block;font-size:10px;color:#64748b;">‚Ä¢ ${esc(rel.menu_items.category)}: <b>${esc(rel.menu_items.name)}</b></span>`:'').join('');
        return `<tr>
          <td style="width:120px;"><b>${esc(m.menu_date)}</b></td>
          <td><b>${esc(m.name)}</b><br><div style="background:#f8fafc;padding:10px;border-radius:12px;border:1px solid #e2e8f0;">${pts}</div></td>
          <td style="text-align:right;">
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button class="smart-btn" onclick="reUse(${m.id})">REUTILIZAR</button>
              <button class="smart-btn danger" onclick="delMenu(${m.id})">X</button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }
    async function reUse(id){
      const { data, error } = await sb.from('menus').select('id, name, menu_date, menu_menu_items(menu_items(name, category, description))').eq('id',id).single();
      if(error||!data) return alert("No se pudo cargar.");
      draft=(data.menu_menu_items||[]).map(rel=>rel.menu_items).filter(Boolean).map(mi=>({name:mi.name,category:mi.category,description:mi.description}));
      menuName.value=data.name; menuDate.value=data.menu_date; renderDraftChips(); switchView('builder'); setBuilderMode('manual'); showToast('Men√∫ cargado');
    }
    async function delMenu(id){
      if(!confirm("¬øBORRAR?")) return;
      await sb.from('menu_menu_items').delete().eq('menu_id',id);
      await sb.from('menus').delete().eq('id',id);
      loadHistory();
    }
    async function delAllMenus(){
      const v=prompt("Escribe BORRAR TODO para confirmar:"); if(v!=='BORRAR TODO') return alert("Cancelado.");
      await sb.from('menu_menu_items').delete().neq('id',0); await sb.from('menus').delete().neq('id',0); loadHistory();
    }

    /* Admin: Cat√°logo */
    async function loadCatTable(){
      const { data } = await sb.from('food_catalog').select('*').order('categoria');
      catalogCache=data||[];
      catTable.innerHTML=catalogCache.map(i=>`
        <tr>
          <td><b>${esc(i.categoria)}</b></td>
          <td>${esc(i.acompanamiento)}</td>
          <td style="text-align:right;">
            <button class="smart-btn" onclick="editCat(${i.id})">‚úèÔ∏è</button>
            <button class="smart-btn" onclick="dupCat(${i.id})">‚ûï</button>
            <button class="smart-btn danger" onclick="delCat(${i.id})">üóëÔ∏è</button>
          </td>
        </tr>`).join('');
    }
    function editCat(id){
      const i=catalogCache.find(x=>x.id===id);
      editCatId.value=i.id; cCat.value=i.categoria; cAcomp.value=i.acompanamiento; cOpc1.value=i.pollo; cOpc2.value=i.cerdo; cOpc3.value=i.carne_roja; cOpc4.value=i.opcion_4;
      btnCancelCat.style.display='inline-flex';
    }
    function dupCat(id){
      const i=catalogCache.find(x=>x.id===id);
      editCatId.value=""; cCat.value=i.categoria; cAcomp.value=i.acompanamiento+" (COPIA)"; cOpc1.value=i.pollo; cOpc2.value=i.cerdo; cOpc3.value=i.carne_roja; cOpc4.value=i.opcion_4;
      btnCancelCat.style.display='inline-flex';
    }
    function resetCatForm(){ editCatId.value=""; cCat.value=""; cAcomp.value=""; cOpc1.value=""; cOpc2.value=""; cOpc3.value=""; cOpc4.value=""; btnCancelCat.style.display='none'; }
    async function saveFood(){
      const p={categoria:cCat.value,acompanamiento:cAcomp.value,pollo:cOpc1.value,cerdo:cOpc2.value,carne_roja:cOpc3.value,opcion_4:cOpc4.value};
      if(editCatId.value) await sb.from('food_catalog').update(p).eq('id',editCatId.value); else await sb.from('food_catalog').insert([p]);
      resetCatForm(); loadCatTable(); loadCatalogPicker();
    }
    async function delCat(id){ if(!confirm('¬øBORRAR?'))return; await sb.from('food_catalog').delete().eq('id',id); loadCatTable(); loadCatalogPicker(); }

    /* Admin: Usuarios */
    async function loadUsrTable(){
      const { data } = await sb.from('user_permissions').select('*').order('email');
      usrTable.innerHTML=(data||[]).map(u=>`
        <tr>
          <td style="text-transform:none;padding:10px;">${esc(u.email)}</td>
          <td style="text-align:right;padding:10px;">
            <button class="smart-btn danger" onclick="delUsr(${u.id})">QUITAR</button>
          </td>
        </tr>`).join('');
    }
    async function saveUsr(){
      await sb.auth.signUp({ email:uEmail.value.trim(), password:uPass.value });
      await sb.from('user_permissions').upsert({ email:uEmail.value.trim().toLowerCase(), can_manage_catalog:pCat.checked, can_manage_users:pUsr.checked });
      uEmail.value=""; uPass.value=""; loadUsrTable(); alert("CREADO");
    }
    async function delUsr(id){ await sb.from('user_permissions').delete().eq('id',id); loadUsrTable(); }

    /* Eventos */
    document.addEventListener('input', e=>{
      if(e.target.tagName==='INPUT' && !['email','password','date'].includes(e.target.type)) e.target.value=e.target.value.toUpperCase();
    });
    btnAddDish.addEventListener('click', addTypedDish);
    btnClearDish.addEventListener('click', ()=>{ typedDish.value=''; hideTypeahead(); typedDish.focus(); });
    btnRefreshCats.addEventListener('click', ()=>{ fillTypedCategory(); showToast('Categor√≠as actualizadas'); });
    typedDish.addEventListener('input', updateTypeahead);
    typedDish.addEventListener('keydown', e=>{
      if(e.key==='ArrowDown'){ e.preventDefault(); moveActive(1); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); moveActive(-1); }
      else if(e.key==='Enter'){ e.preventDefault(); chooseActive(); }
      else if(e.key==='Escape'){ hideTypeahead(); typedDish.value=''; }
    });
    typedCategory.addEventListener('change', updateTypeahead);
    document.addEventListener('click', e=>{ if(!typeahead.contains(e.target) && e.target!==typedDish) hideTypeahead(); });
    btnClearDraft.addEventListener('click', clearDraft);
    btnSortDraft.addEventListener('click', sortDraftAZ);
    btnExportDraft.addEventListener('click', exportDraftText);

    /* Init */
    menuDate.value=(new Date()).toISOString().slice(0,10);
    loadSavedMenus();
    check();
    setBuilderMode('catalog');
  </script>

  <div id="toast" class="toast hidden"></div>
</body>
</html>
``
