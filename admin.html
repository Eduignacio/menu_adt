<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Menú</title>
  <style>
    :root{
      --bg:#f5f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --primary:#111827;
      --primaryText:#ffffff;

      --danger:#dc2626;
      --dangerText:#ffffff;

      --ring: rgba(17, 24, 39, .14);

      --radius:16px;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:20px 16px 56px;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: 0 10px 24px rgba(15,23,42,.04);
    }

    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand h1{
      font-size:22px;
      line-height:1.1;
      margin:0;
      letter-spacing:-.02em;
      font-weight:900;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .topActions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Buttons */
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      color:var(--text);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ box-shadow: 0 10px 18px rgba(15,23,42,.06); }

    .btnPrimary{
      background:var(--primary);
      border-color:var(--primary);
      color:var(--primaryText);
    }
    .btnDanger{
      background:var(--danger);
      border-color:var(--danger);
      color:var(--dangerText);
    }
    .btnGhost{
      background:transparent;
    }
    .btnSmall{ padding:8px 10px; font-size:13px; }

    /* Layout */
    .grid{
      display:grid;
      gap:14px;
      margin-top:14px;
    }
    .grid2{ grid-template-columns: 1.1fr .9fr; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: 0 10px 24px rgba(15,23,42,.04);
    }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0 0 10px;
    }
    .sectionTitle h2{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:-.01em;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      background:#fafafa;
    }

    .muted{ color:var(--muted); }
    .small{ font-size:12px; }
    .divider{ height:1px; background:var(--line); margin:12px 0; }

    /* Forms */
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      margin:10px 0 6px;
    }

    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:11px 12px;
      background:#fff;
      font-size:14px;
      color:var(--text);
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }

    input:focus, textarea:focus, select:focus{
      border-color: #cbd5e1;
      box-shadow: 0 0 0 4px var(--ring);
    }
    textarea{ min-height:92px; resize:vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .grid3{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .grid3{ grid-template-columns:1fr; } }

    /* Tables */
    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      border-top:1px solid var(--line);
      padding:10px 10px;
      text-align:left;
      vertical-align:top;
      font-size:14px;
    }
    th{
      background:#fafafa;
      border-top:none;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:950;
    }

    /* Mini Search with clear */
    .searchWrap{ position:relative; }
    .searchWrap input{ padding-right:44px; }
    .clearX{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:34px; height:34px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:950;
    }

    .hidden{ display:none!important; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>Admin Menú</h1>
        <p>Panel simple para crear menús y gestionar platos</p>
      </div>

      <div class="topActions">
        <a class="btn" href="./index.html">← Volver al menú</a>
        <button class="btn btnGhost" id="btnLogout" style="display:none;">Cerrar sesión</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard" style="margin-top:14px;">
      <div class="sectionTitle">
        <h2>Iniciar sesión</h2>
        <span class="badge">Solo autenticados</span>
      </div>
      <p class="muted small" style="margin:0 0 12px;">
        Solo usuarios autenticados pueden crear/editar/borrar menús y platos.
      </p>

      <div class="grid3">
        <div style="grid-column: span 1;">
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="tu@email.com" />
        </div>
        <div style="grid-column: span 1;">
          <label>Contraseña</label>
          <input id="loginPass" type="password" placeholder="••••••••" />
        </div>
        <div style="display:flex; align-items:end;">
          <button class="btn btnPrimary" id="btnLogin" type="button" style="width:100%; justify-content:center;">
            Entrar
          </button>
        </div>
      </div>

      <div class="muted small" style="margin-top:10px;">
        Si no tienes usuario, créalo en Supabase: <b>Authentication → Users → Add user</b> (email + password).
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <div class="grid grid2">
        <!-- MENUS -->
        <div class="card">
          <div class="sectionTitle">
            <h2>Gestión de Menús</h2>
            <span class="badge">Sesión iniciada ✅</span>
          </div>
          <p class="muted small" style="margin:0 0 8px;">
            Crea, edita o borra menús. Después agrega platos desde el historial.
          </p>

          <div class="grid3">
            <div>
              <label>Historial de menús</label>
              <select id="menuSelect"></select>
              <div class="muted small" style="margin-top:6px;">Selecciona un menú para editar o reutilizar.</div>
            </div>

            <div>
              <label>Nombre del menú</label>
              <input id="menuName" placeholder="Ej: Menú del día" />
            </div>

            <div>
              <label>Fecha del menú</label>
              <input id="menuDate" type="date" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div class="muted small" id="menuStatus">—</div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn btnPrimary" id="btnCreateMenu" type="button">Agregar menú</button>
              <button class="btn" id="btnUpdateMenu" type="button">Editar menú</button>
              <button class="btn btnDanger" id="btnDeleteMenu" type="button">Borrar menú</button>
            </div>
          </div>
        </div>

        <!-- QUICK STATS / HELP -->
        <div class="card">
          <div class="sectionTitle">
            <h2>Platos del menú</h2>
            <span class="badge" id="menuItemsCount">0 plato(s)</span>
          </div>
          <p class="muted small" style="margin:0;">
            Usa el panel de abajo para crear platos, reutilizarlos y ordenar tu menú del día.
          </p>
          <div class="divider"></div>
          <p class="muted small" style="margin:0;">
            Tip: doble click en un plato del historial para cargarlo y editarlo.
          </p>
        </div>
      </div>

      <!-- PLATOS -->
      <div class="card" style="margin-top:14px;">
        <div class="sectionTitle">
          <h2>Platos del menú seleccionado</h2>
        </div>

        <div class="grid grid2" style="margin-top:6px;">
          <!-- Agregar / Editar plato -->
          <div class="card" style="box-shadow:none;">
            <div class="sectionTitle">
              <h2>Agregar / editar plato</h2>
              <span class="badge">Historial + Menú</span>
            </div>

            <input id="itemId" type="hidden" />

            <label>Nombre</label>
            <input id="itemName" placeholder="Ej: Hamburguesa clásica" />

            <div class="grid3" style="grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <label>Categoría</label>
                <select id="itemCategory">
                  <option value="">(Sin categoría)</option>
                  <option value="Entrada">Entrada</option>
                  <option value="Principal">Principal</option>
                  <option value="Postre">Postre</option>
                  <option value="Bebida">Bebida</option>
                  <option value="Acompañamiento">Acompañamiento</option>
                </select>
              </div>
              <div>
                <label>Fecha del plato (opcional)</label>
                <input id="itemDate" type="date" />
              </div>
            </div>

            <label>Descripción</label>
            <textarea id="itemDesc" placeholder="Ej: Carne, queso, tomate y papas"></textarea>

            <div class="row" style="margin-top:12px; justify-content:flex-end;">
              <button class="btn" id="btnClearItem" type="button">Limpiar</button>
              <button class="btn btnPrimary" id="btnSaveItem" type="button">Guardar</button>
              <button class="btn btnDanger" id="btnDeleteItem" type="button">Borrar (historial)</button>
            </div>

            <div class="muted small" style="margin-top:8px;">
              Guardar = queda en historial y se agrega al menú actual.
            </div>
          </div>

          <!-- Historial -->
          <div class="card" style="box-shadow:none;">
            <div class="sectionTitle">
              <h2>Reutilizar del historial</h2>
              <span class="badge">Buscar + Agregar</span>
            </div>

            <label>Buscar</label>
            <div class="searchWrap">
              <input id="searchItems" placeholder="Filtra por nombre / categoría / descripción" />
              <button id="btnClearSearch" class="clearX" type="button">×</button>
            </div>

            <div style="margin-top:12px; max-height:320px; overflow:auto;" class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Plato</th>
                    <th>Categoría</th>
                    <th>Descripción</th>
                    <th style="width:120px;">Acción</th>
                  </tr>
                </thead>
                <tbody id="historyItemsTbody">
                  <tr><td colspan="4" class="muted">Cargando...</td></tr>
                </tbody>
              </table>
            </div>

            <div class="muted small" style="margin-top:10px;">
              Reutiliza platos en otros menús sin duplicarlos.
            </div>
          </div>
        </div>

        <!-- Tabla menú -->
        <div class="divider"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:60px;">Nº</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th style="width:220px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="menuItemsTbody">
              <tr><td colspan="5" class="muted">Selecciona un menú…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="muted small" style="margin-top:10px;">
          Nota: el ID está oculto. Si editas, usamos el ID internamente.
        </div>
      </div>

    </div><!-- /app -->
  </div><!-- /wrap -->

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginCard = document.getElementById("loginCard");
    const app = document.getElementById("app");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");

    const menuSelect = document.getElementById("menuSelect");
    const menuName = document.getElementById("menuName");
    const menuDate = document.getElementById("menuDate");
    const menuStatus = document.getElementById("menuStatus");
    const btnCreateMenu = document.getElementById("btnCreateMenu");
    const btnUpdateMenu = document.getElementById("btnUpdateMenu");
    const btnDeleteMenu = document.getElementById("btnDeleteMenu");

    const itemId = document.getElementById("itemId");
    const itemName = document.getElementById("itemName");
    const itemCategory = document.getElementById("itemCategory");
    const itemDate = document.getElementById("itemDate");
    const itemDesc = document.getElementById("itemDesc");
    const btnSaveItem = document.getElementById("btnSaveItem");
    const btnClearItem = document.getElementById("btnClearItem");
    const btnDeleteItem = document.getElementById("btnDeleteItem");

    const searchItems = document.getElementById("searchItems");
    const btnClearSearch = document.getElementById("btnClearSearch");
    const historyItemsTbody = document.getElementById("historyItemsTbody");

    const menuItemsTbody = document.getElementById("menuItemsTbody");
    const menuItemsCount = document.getElementById("menuItemsCount");

    let menusCache = [];
    let historyItemsCache = [];
    let currentMenuId = null;

    function fmtDate(d) {
      if (!d) return "";
      try { const [y,m,dd] = d.split("-"); return `${dd}-${m}-${y}`; } catch { return d; }
    }

    function setDefaultMenuDateIfEmpty() {
      if (!menuDate.value) {
        const t = new Date();
        const yyyy = t.getFullYear();
        const mm = String(t.getMonth() + 1).padStart(2, "0");
        const dd = String(t.getDate()).padStart(2, "0");
        menuDate.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    function cleanItemForm() {
      itemId.value = "";
      itemName.value = "";
      itemCategory.value = "";
      itemDate.value = "";
      itemDesc.value = "";
    }

    async function refreshAuthUI() {
      const { data } = await supabaseClient.auth.getSession();
      const loggedIn = !!data.session;

      loginCard.classList.toggle("hidden", loggedIn);
      app.classList.toggle("hidden", !loggedIn);
      btnLogout.style.display = loggedIn ? "inline-flex" : "none";

      if (loggedIn) {
        setDefaultMenuDateIfEmpty();
        await loadMenus();
        await loadHistoryItems();
        await setCurrentMenuFromSelect();
      }
    }

    btnLogin.addEventListener("click", async () => {
      const email = loginEmail.value.trim();
      const password = loginPass.value;
      if (!email || !password) return alert("Completa email y contraseña.");

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return alert("Login falló: " + error.message);
      await refreshAuthUI();
    });

    btnLogout.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      await refreshAuthUI();
    });

    async function loadMenus() {
      const { data, error } = await supabaseClient
        .from("menus")
        .select("id,name,menu_date,created_at")
        .order("menu_date", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        menuStatus.textContent = "Error cargando menús.";
        menusCache = [];
        menuSelect.innerHTML = `<option value="">(Error)</option>`;
        return;
      }

      menusCache = data || [];
      if (menusCache.length === 0) {
        menuSelect.innerHTML = `<option value="">No hay menús (crea uno)</option>`;
        currentMenuId = null;
        menuName.value = "";
        setDefaultMenuDateIfEmpty();
        menuStatus.textContent = "Crea tu primer menú.";
        menuItemsTbody.innerHTML = `<tr><td colspan="5" class="muted">Crea un menú para comenzar…</td></tr>`;
        menuItemsCount.textContent = "0 plato(s)";
        return;
      }

      menuSelect.innerHTML = menusCache.map(m => {
        const label = `${m.name || "Menú"}${m.menu_date ? " — " + fmtDate(m.menu_date) : ""}`;
        return `<option value="${m.id}">${label}</option>`;
      }).join("");
    }

    async function setCurrentMenuFromSelect() {
      const val = menuSelect.value || (menusCache[0] ? menusCache[0].id : null);
      if (!val) return;

      menuSelect.value = val;
      currentMenuId = val;

      const m = menusCache.find(x => String(x.id) === String(val));
      menuName.value = (m && m.name) ? m.name : "";
      menuDate.value = (m && m.menu_date) ? m.menu_date : menuDate.value;

      menuStatus.textContent = `Menú seleccionado: ${menuName.value || "Menú"}${menuDate.value ? " (" + fmtDate(menuDate.value) + ")" : ""}`;
      await loadMenuItems();
    }

    menuSelect.addEventListener("change", setCurrentMenuFromSelect);

    btnCreateMenu.addEventListener("click", async () => {
      setDefaultMenuDateIfEmpty();
      const name = menuName.value.trim() || "Menú";
      const date = menuDate.value || null;

      const { data, error } = await supabaseClient
        .from("menus")
        .insert([{ name, menu_date: date }])
        .select("id,name,menu_date,created_at")
        .single();

      if (error) return alert("No se pudo crear el menú: " + error.message);

      await loadMenus();
      menuSelect.value = data.id;
      await setCurrentMenuFromSelect();
      alert("Menú creado ✅");
    });

    btnUpdateMenu.addEventListener("click", async () => {
      if (!currentMenuId) return alert("No hay menú seleccionado.");
      setDefaultMenuDateIfEmpty();
      const name = menuName.value.trim() || "Menú";
      const date = menuDate.value || null;

      const { error } = await supabaseClient
        .from("menus")
        .update({ name, menu_date: date })
        .eq("id", currentMenuId);

      if (error) return alert("No se pudo actualizar: " + error.message);

      await loadMenus();
      menuSelect.value = currentMenuId;
      await setCurrentMenuFromSelect();
      alert("Menú actualizado ✅");
    });

    btnDeleteMenu.addEventListener("click", async () => {
      if (!currentMenuId) return alert("No hay menú seleccionado.");
      if (!confirm("¿Seguro que quieres borrar este menú? (No borra los platos del historial)")) return;

      const rel = await supabaseClient.from("menu_menu_items").delete().eq("menu_id", currentMenuId);
      if (rel.error) return alert("No se pudo borrar relación: " + rel.error.message);

      const { error } = await supabaseClient.from("menus").delete().eq("id", currentMenuId);
      if (error) return alert("No se pudo borrar el menú: " + error.message);

      currentMenuId = null;
      await loadMenus();
      await setCurrentMenuFromSelect();
      alert("Menú borrado ✅");
    });

    async function loadHistoryItems() {
      const { data, error } = await supabaseClient
        .from("menu_items")
        .select("id,name,category,description,item_date,created_at")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        historyItemsCache = [];
        historyItemsTbody.innerHTML = `<tr><td colspan="4" class="muted">Error cargando historial.</td></tr>`;
        return;
      }

      historyItemsCache = data || [];
      renderHistory();
    }

    function renderHistory() {
      const q = (searchItems.value || "").toLowerCase().trim();
      const filtered = !q ? historyItemsCache : historyItemsCache.filter(it =>
        (it.name || "").toLowerCase().includes(q) ||
        (it.category || "").toLowerCase().includes(q) ||
        (it.description || "").toLowerCase().includes(q)
      );

      if (filtered.length === 0) {
        historyItemsTbody.innerHTML = `<tr><td colspan="4" class="muted">Sin resultados.</td></tr>`;
        return;
      }

      historyItemsTbody.innerHTML = filtered.map(it => `
        <tr>
          <td><b>${it.name || "Sin nombre"}</b></td>
          <td>${it.category || ""}</td>
          <td>${it.description || ""}</td>
          <td><button class="btn btnPrimary btnSmall" data-add="${it.id}">Agregar</button></td>
        </tr>
      `).join("");

      historyItemsTbody.querySelectorAll("button[data-add]").forEach(btn => {
        btn.addEventListener("click", () => addExistingItemToMenu(btn.getAttribute("data-add")));
      });
    }

    searchItems.addEventListener("input", renderHistory);
    btnClearSearch.addEventListener("click", () => {
      searchItems.value = "";
      renderHistory();
    });

    async function loadMenuItems() {
      if (!currentMenuId) {
        menuItemsTbody.innerHTML = `<tr><td colspan="5" class="muted">Selecciona un menú…</td></tr>`;
        menuItemsCount.textContent = "0 plato(s)";
        return;
      }

      const { data, error } = await supabaseClient
        .from("menu_menu_items")
        .select("id, menu_item_id, menu_items:menu_item_id (id,name,category,description,item_date)")
        .eq("menu_id", currentMenuId)
        .order("id", { ascending: true });

      if (error) {
        console.error(error);
        menuItemsTbody.innerHTML = `<tr><td colspan="5" class="muted">Error cargando platos del menú.</td></tr>`;
        menuItemsCount.textContent = "0 plato(s)";
        return;
      }

      const rows = (data || []).map(r => ({
        linkId: r.id,
        item: r.menu_items
      })).filter(x => x.item);

      menuItemsCount.textContent = `${rows.length} plato(s)`;

      if (rows.length === 0) {
        menuItemsTbody.innerHTML = `<tr><td colspan="5" class="muted">Este menú aún no tiene platos.</td></tr>`;
        return;
      }

      menuItemsTbody.innerHTML = rows.map((r, idx) => `
        <tr>
          <td><b>${idx + 1}</b></td>
          <td><b>${r.item.name || "Sin nombre"}</b></td>
          <td>${r.item.category || ""}</td>
          <td>${r.item.description || ""}</td>
          <td>
            <button class="btn btnSmall" data-edit="${r.item.id}">Editar</button>
            <button class="btn btnDanger btnSmall" data-remove="${r.linkId}">Quitar</button>
          </td>
        </tr>
      `).join("");

      menuItemsTbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => fillEditItem(btn.getAttribute("data-edit")));
      });
      menuItemsTbody.querySelectorAll("button[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => removeItemFromMenu(btn.getAttribute("data-remove")));
      });
    }

    async function addExistingItemToMenu(menuItemId) {
      if (!currentMenuId) return alert("Primero crea/selecciona un menú.");

      const { data: existing, error: exErr } = await supabaseClient
        .from("menu_menu_items")
        .select("id")
        .eq("menu_id", currentMenuId)
        .eq("menu_item_id", menuItemId)
        .maybeSingle();

      if (exErr) return alert("Error verificando duplicado: " + exErr.message);
      if (existing) return alert("Ese plato ya está en este menú.");

      const { error } = await supabaseClient
        .from("menu_menu_items")
        .insert([{ menu_id: currentMenuId, menu_item_id: menuItemId }]);

      if (error) return alert("No se pudo agregar al menú: " + error.message);

      await loadMenuItems();
    }

    async function removeItemFromMenu(linkId) {
      if (!confirm("¿Quitar este plato del menú? (No se borra del historial)")) return;

      const { error } = await supabaseClient
        .from("menu_menu_items")
        .delete()
        .eq("id", linkId);

      if (error) return alert("No se pudo quitar: " + error.message);

      await loadMenuItems();
    }

    function fillEditItem(id) {
      const it = historyItemsCache.find(x => String(x.id) === String(id));
      if (!it) return;

      itemId.value = it.id;
      itemName.value = it.name || "";
      itemCategory.value = it.category || "";
      itemDate.value = it.item_date || "";
      itemDesc.value = it.description || "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    btnClearItem.addEventListener("click", cleanItemForm);

    btnSaveItem.addEventListener("click", async () => {
      if (!currentMenuId) return alert("Primero crea/selecciona un menú.");

      const name = itemName.value.trim();
      if (!name) return alert("El nombre del plato es obligatorio.");

      const payload = {
        name,
        category: itemCategory.value || null,
        description: itemDesc.value.trim() || null,
        item_date: itemDate.value || null
      };

      let savedId = itemId.value ? Number(itemId.value) : null;

      if (savedId) {
        const { error } = await supabaseClient.from("menu_items").update(payload).eq("id", savedId);
        if (error) return alert("No se pudo actualizar el plato: " + error.message);
      } else {
        const { data, error } = await supabaseClient
          .from("menu_items")
          .insert([payload])
          .select("id")
          .single();

        if (error) return alert("No se pudo crear el plato: " + error.message);
        savedId = data.id;
      }

      const { data: existing } = await supabaseClient
        .from("menu_menu_items")
        .select("id")
        .eq("menu_id", currentMenuId)
        .eq("menu_item_id", savedId)
        .maybeSingle();

      if (!existing) {
        const { error } = await supabaseClient
          .from("menu_menu_items")
          .insert([{ menu_id: currentMenuId, menu_item_id: savedId }]);

        if (error) return alert("Plato guardado, pero no se pudo agregar al menú: " + error.message);
      }

      await loadHistoryItems();
      await loadMenuItems();
      cleanItemForm();
      alert("Plato guardado ✅");
    });

    btnDeleteItem.addEventListener("click", async () => {
      if (!itemId.value) return alert("Selecciona un plato para borrar (doble click en historial o Editar).");
      if (!confirm("¿Seguro? Esto borra el plato del historial (y lo quitará de todos los menús).")) return;

      const id = Number(itemId.value);

      const rel = await supabaseClient.from("menu_menu_items").delete().eq("menu_item_id", id);
      if (rel.error) return alert("No se pudo borrar relaciones: " + rel.error.message);

      const { error } = await supabaseClient.from("menu_items").delete().eq("id", id);
      if (error) return alert("No se pudo borrar el plato: " + error.message);

      await loadHistoryItems();
      await loadMenuItems();
      cleanItemForm();
      alert("Plato borrado ✅");
    });

    historyItemsTbody.addEventListener("dblclick", (e) => {
      const tr = e.target.closest("tr");
      if (!tr) return;
      const btn = tr.querySelector("button[data-add]");
      if (!btn) return;
      fillEditItem(btn.getAttribute("data-add"));
    });

    refreshAuthUI();
  </script>
</body>
</html>
