<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADMIN MATRIX - ADT</title>
  <style>
    :root { --sidebar: #0f172a; --accent: #6366f1; --bg: #f1f5f9; --card: #fff; }
    * { box-sizing: border-box; text-transform: uppercase; font-family: sans-serif; }
    body { margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }

    /* SIDEBAR CATÁLOGO */
    .sidebar { width: 360px; background: var(--sidebar); color: #fff; display: flex; flex-direction: column; border-right: 1px solid #e2e8f0; }
    .sb-header { padding: 20px; background: #1e293b; border-bottom: 1px solid #334155; }
    .sb-content { flex: 1; overflow-y: auto; padding: 15px; }
    
    .cat-group { margin-bottom: 20px; }
    .cat-name { font-size: 11px; font-weight: 900; color: var(--accent); margin-bottom: 8px; border-left: 3px solid var(--accent); padding-left: 8px; }
    .food-card { background: #1e293b; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #334155; }
    .food-card b { display: block; font-size: 12px; margin-bottom: 8px; color: #f1f5f9; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
    .btn-quick { font-size: 8px; padding: 6px; background: #334155; border: none; color: white; cursor: pointer; border-radius: 4px; font-weight: 800; }
    .btn-quick:hover { background: var(--accent); }

    /* ÁREA PRINCIPAL */
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    .top-nav { padding: 15px 30px; background: #fff; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
    .content { padding: 30px; max-width: 900px; margin: 0 auto; width: 100%; }
    
    .builder-card { background: #fff; border-radius: 12px; padding: 25px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .plate-item { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    
    input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-weight: 800; font-size: 13px; }
    label { font-size: 10px; font-weight: 900; color: #64748b; margin-bottom: 5px; display: block; }
    .btn-save { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 900; width: 100%; }
    
    #loginOverlay { position: fixed; inset: 0; background: var(--sidebar); z-index: 999; display: flex; align-items: center; justify-content: center; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loginOverlay">
    <div style="background:white; padding:30px; border-radius:15px; width:300px;">
      <h3 style="text-align:center;">LOGIN ADMIN</h3>
      <input id="lemail" placeholder="EMAIL" style="margin-bottom:10px;">
      <input id="lpass" type="password" placeholder="CONTRASEÑA">
      <button onclick="login()" class="btn-save" style="margin-top:15px;">ENTRAR</button>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sb-header"><h2>CATÁLOGO RÁPIDO</h2></div>
    <div class="sb-content" id="catalogBox"></div>
  </aside>

  <main class="main hidden" id="app">
    <div class="top-nav">
      <b>CONSTRUCTOR DE MENÚS</b>
      <button onclick="logout()">SALIR</button>
    </div>
    <div class="content">
      <div class="builder-card">
        <div class="row">
          <div><label>NOMBRE DEL MENÚ</label><input id="mName" value="ALMUERZO DEL DÍA"></div>
          <div><label>FECHA</label><input id="mDate" type="date"></div>
          <div style="display:flex; align-items:flex-end;"><button class="btn-save" onclick="saveMenu()">PUBLICAR MENÚ</button></div>
        </div>
        <div id="plateList"></div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const S_URL = "https://wljgbmgpjqvmaphrlwyh.supabase.co";
    const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsamdibWdwanF2bWFwaHJsd3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzA5NTAsImV4cCI6MjA4MTkwNjk1MH0.V4N_0vDA6ZYWfwNVoUH-QWuHMsElQENBDORs-aON8Cg";
    const supabase = window.supabase.createClient(S_URL, S_KEY);

    let currentPlates = [];

    async function login() {
      const { error } = await supabase.auth.signInWithPassword({ email: lemail.value, password: lpass.value });
      if (error) alert("ERROR"); else location.reload();
    }
    
    async function logout() { await supabase.auth.signOut(); location.reload(); }

    async function check() {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        loginOverlay.classList.add('hidden');
        app.classList.remove('hidden');
        loadCatalog();
      }
    }

    async function loadCatalog() {
      const { data } = await supabase.from('food_catalog').select('*').order('categoria');
      const box = document.getElementById('catalogBox');
      const grouped = data.reduce((acc, i) => { (acc[i.categoria] = acc[i.categoria] || []).push(i); return acc; }, {});
      
      box.innerHTML = Object.keys(grouped).map(cat => `
        <div class="cat-group">
          <div class="cat-name">${cat}</div>
          ${grouped[cat].map(i => `
            <div class="food-card">
              <b>${i.acompanamiento}</b>
              <div class="btn-grid">
                <button class="btn-quick" onclick="add('${i.acompanamiento}', '${i.pollo}', '${cat}')">POLLO</button>
                <button class="btn-quick" onclick="add('${i.acompanamiento}', '${i.cerdo}', '${cat}')">CERDO</button>
                <button class="btn-quick" onclick="add('${i.acompanamiento}', '${i.carne_roja}', '${cat}')">CARNE</button>
              </div>
            </div>`).join('')}
        </div>`).join('');
    }

    function add(a, p, c) {
      currentPlates.push({ name: `${a} + ${p}`, category: c, description: `ACOMPAÑAMIENTO: ${a} | PROTEÍNA: ${p}` });
      render();
    }

    function render() {
      plateList.innerHTML = currentPlates.map((p, i) => `
        <div class="plate-item">
          <div><b>${p.name}</b><br><small>${p.category}</small></div>
          <button onclick="currentPlates.splice(${i},1);render()">X</button>
        </div>`).join('');
    }

    async function saveMenu() {
      const name = mName.value, date = mDate.value;
      if (!date || !currentPlates.length) return alert("FALTA FECHA O PLATOS");
      
      const { data: menu } = await supabase.from('menus').insert([{ name, menu_date: date }]).select().single();
      for (const p of currentPlates) {
        const { data: item } = await supabase.from('menu_items').insert([p]).select().single();
        await supabase.from('menu_menu_items').insert([{ menu_id: menu.id, menu_item_id: item.id }]);
      }
      alert("MENÚ PUBLICADO"); currentPlates = []; render();
    }

    mDate.value = new Date().toISOString().split('T')[0];
    check();
  </script>
</body>
</html>
